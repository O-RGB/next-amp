<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"
    />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />
    <meta name="theme-color" content="#111111" />
    <link rel="manifest" href="manifest.json" />

    <title>Nextamp Remastered</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@400;500;600&family=Inter:wght@400;600&display=swap"
      rel="stylesheet"
    />

    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              "win-base": "#1a1a1a",
              "win-gray": "#292929",
              "btn-face": "#c0c0c0",
              "win-green": "#00ff00",
              "win-gold": "#ffcc00",
            },
            fontFamily: {
              pixel: ['"Chakra Petch"', "sans-serif"],
              ui: ['"Inter"', "sans-serif"],
            },
            cursor: { "win-pointer": "default" },
          },
        },
      };
    </script>
    <style>
      /* APP-LIKE BEHAVIOR */
      html,
      body {
        height: 100%;
        width: 100%;
        overflow: hidden;
        overscroll-behavior: none;
        touch-action: none;
        user-select: none;
        -webkit-user-select: none;
        background-color: #111;

        /* SAFE AREA PADDING LOGIC */
        padding-top: max(4px, env(safe-area-inset-top));
        padding-bottom: max(4px, env(safe-area-inset-bottom));
        padding-left: max(4px, env(safe-area-inset-left));
        padding-right: max(4px, env(safe-area-inset-right));
      }

      /* Nextamp Styles */
      .win-btn {
        background-color: #c0c0c0;
        color: black;
        border-top: 2px solid #fff;
        border-left: 2px solid #fff;
        border-right: 2px solid #000;
        border-bottom: 2px solid #000;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 11px;
        font-weight: bold;
        z-index: 30;
      }
      .win-btn:active,
      .win-btn.pressed {
        border-top: 2px solid #000;
        border-left: 2px solid #000;
        border-right: 2px solid #fff;
        border-bottom: 2px solid #fff;
      }
      .win-btn.pressed {
        background-color: #a0a0a0;
      }

      input[type="range"] {
        -webkit-appearance: none;
        background: transparent;
      }
      input[type="range"]:focus {
        outline: none;
      }
      input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        height: 10px;
        width: 14px;
        background: #c0c0c0;
        border: 1px solid #000;
        box-shadow: inset 1px 1px #fff;
        cursor: pointer;
        position: relative;
        z-index: 20;
        margin-top: -3px;
      }
      input[type="range"]::-webkit-slider-runnable-track {
        width: 100%;
        height: 4px;
        background: #000;
        border-bottom: 1px solid #333;
      }
      input[type="range"].vertical {
        writing-mode: bt-lr;
        -webkit-appearance: slider-vertical;
        width: 15px;
        margin: 0;
        padding: 0;
        opacity: 0;
        position: absolute;
        top: 0;
        left: 0;
        height: 100%;
        z-index: 20;
        cursor: pointer;
      }

      .custom-scroll::-webkit-scrollbar {
        width: 10px;
        background: #292929;
      }
      .custom-scroll::-webkit-scrollbar-thumb {
        background: #c0c0c0;
        border: 1px solid #fff;
        border-right: 1px solid #000;
        border-bottom: 1px solid #000;
      }
      .text-shadow {
        text-shadow: 0px 0px 2px rgba(0, 255, 0, 0.4);
      }
      .eq-bar-bg {
        background: linear-gradient(to top, #444 0%, #444 100%);
        width: 4px;
        height: 100%;
        margin: 0 auto;
        border-left: 1px solid #222;
        border-right: 1px solid #666;
      }
      .eq-bar-active {
        background: linear-gradient(
          to top,
          #00ff00 0%,
          #ffff00 70%,
          #ff0000 100%
        );
        box-shadow: 0 0 2px #0f0;
      }
      .eq-thumb {
        width: 12px;
        height: 6px;
        background: #c0c0c0;
        border: 1px solid #000;
        border-top: 1px solid #fff;
        border-left: 1px solid #fff;
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
        pointer-events: none;
        z-index: 10;
      }
      .active-indicator {
        color: #00ff00 !important;
      }
      .dragging {
        opacity: 0.5;
        background: #444;
      }
      .drag-over {
        border-top: 2px solid #00ff00;
      }
    </style>
  </head>
  <body class="flex items-center justify-center w-full h-full">
    <div
      id="boot-screen"
      class="fixed inset-0 z-[100] bg-[#111] flex flex-col items-center justify-center font-ui select-none"
    >
      <div
        class="w-72 bg-[#c0c0c0] border-t-2 border-l-2 border-white border-r-2 border-b-2 border-black p-1 shadow-lg flex flex-col"
      >
        <div
          class="bg-[#000080] w-full text-white text-[12px] font-bold px-2 py-1 mb-4 flex justify-between items-center"
        >
          <div class="flex items-center gap-2">
            <i class="ph-bold ph-music-note"></i>
            <span>System Initialization</span>
          </div>
          <button
            class="bg-[#c0c0c0] text-black w-4 h-4 flex items-center justify-center border border-white text-[10px] shadow-sm leading-none"
          >
            X
          </button>
        </div>

        <div class="px-4 pb-4 flex flex-col items-center text-center">
          <div class="mb-4 flex items-center gap-4">
            <i class="ph-fill ph-speaker-high text-4xl text-gray-600"></i>
            <div class="text-left">
              <h1 class="text-sm font-bold text-black">Audio Engine Setup</h1>
              <p class="text-[11px] text-gray-600">
                Tap start to initialize system.
              </p>
            </div>
          </div>

          <div
            class="w-full h-4 border-t border-l border-gray-600 border-r border-b border-white mb-4 p-[2px] bg-white"
          >
            <div class="h-full bg-[#000080] w-full animate-pulse"></div>
          </div>

          <button
            id="btn-boot-start"
            class="win-btn px-6 py-1 text-xs font-bold active:border-t-black active:border-l-black active:border-r-white active:border-b-white focus:outline-dotted"
          >
            Start Application
          </button>
        </div>
      </div>

      <div class="mt-4 text-[10px] text-gray-500 font-pixel">
        POWERED BY NEXTAMP
      </div>
    </div>

    <audio
      id="audio-startup"
      src="/assets/sounds/startup.mp3"
      preload="auto"
    ></audio>
    <audio
      id="audio-loop"
      src="/assets/sounds/allow-sound.mp3"
      loop
      preload="auto"
    ></audio>

    <button
      id="btn-install-pwa"
      class="hidden fixed top-2 right-2 z-50 bg-win-green text-black px-3 py-1 text-xs font-bold border-2 border-white shadow-lg animate-bounce"
    >
      INSTALL APP
    </button>

    <div class="w-full h-full md:max-w-sm mx-auto">
      <div
        class="flex flex-col gap-2 origin-center transition-transform duration-300 h-full"
      >
        <div
          class="bg-[#292929] border-t-2 border-l-2 border-gray-500 border-r-2 border-b-2 border-black relative z-20 shadow-lg"
        >
          <div
            class="h-5 bg-[#000080] flex justify-between items-center px-1 text-white text-[10px] font-bold cursor-grab"
          >
            <div class="flex items-center gap-1">
              <i class="ph-bold ph-music-note"></i>
              <span>NEXTAMP</span>
            </div>
            <div class="flex gap-1 items-center">
              <div
                id="engine-status"
                class="w-2 h-2 rounded-full bg-red-900 border border-black mr-1"
                title="Engine Status"
              ></div>
              <button
                class="w-3 h-3 bg-btn-face text-black flex items-center justify-center border border-white text-[8px] leading-none"
              >
                _
              </button>
              <button
                class="w-3 h-3 bg-btn-face text-black flex items-center justify-center border border-white text-[8px] leading-none"
              >
                X
              </button>
            </div>
          </div>
          <div class="p-2">
            <div
              class="bg-black border-2 border-gray-600 border-r-white/50 border-b-white/50 border-r-gray p-2 mb-2 flex gap-3 h-[80px] shadow-inner relative overflow-hidden"
            >
              <div class="w-[65%] flex flex-col min-w-0 relative">
                <div
                  id="marquee"
                  class="font-pixel text-win-green text-sm whitespace-nowrap overflow-hidden leading-none mb-1 text-shadow pt-1"
                >
                  Ready.
                </div>
                <div
                  class="flex-1 border border-gray-700 relative w-full bg-[#111] overflow-hidden"
                >
                  <canvas
                    id="visualizer"
                    class="w-full h-full absolute top-0 left-0 block"
                  ></canvas>
                </div>
              </div>
              <div
                class="flex-1 flex flex-col justify-between items-end bg-[#111] p-1 border border-gray-700 shrink-0 z-10 min-w-[80px]"
              >
                <div
                  id="time-display"
                  class="font-pixel text-3xl text-win-green leading-none tracking-widest text-shadow mt-[-2px]"
                >
                  00:00
                </div>
                <div class="text-right w-full">
                  <div
                    class="font-pixel text-win-gold text-[10px] leading-none"
                  >
                    192 k
                  </div>
                  <div
                    class="font-pixel text-win-gold text-[10px] leading-none"
                  >
                    44 khz
                  </div>
                  <div
                    class="font-pixel text-win-green text-[10px] mt-1 leading-none text-center border border-gray-800"
                  >
                    STEREO
                  </div>
                </div>
              </div>
            </div>
            <div class="flex flex-col gap-1 mb-2">
              <div class="relative h-4">
                <input
                  type="range"
                  id="playback"
                  min="0"
                  max="1"
                  step="0.001"
                  value="0"
                  class="w-full h-3 cursor-pointer"
                />
              </div>
              <div class="flex justify-between items-center gap-2 px-1">
                <div class="flex flex-col flex-1">
                  <div
                    class="flex justify-between text-[8px] text-win-green font-pixel"
                  >
                    <span>VOL</span><span id="txt-vol">80%</span>
                  </div>
                  <input
                    type="range"
                    id="main-vol"
                    min="0"
                    max="1"
                    step="0.01"
                    value="0.8"
                    class="w-full h-2 bg-black border border-gray-600"
                  />
                </div>
                <div class="flex flex-col w-[80px]">
                  <div
                    class="flex justify-between text-[8px] text-win-gold font-pixel"
                  >
                    <span>L</span><span>BAL</span><span>R</span>
                  </div>
                  <input
                    type="range"
                    id="main-bal"
                    min="-1"
                    max="1"
                    step="0.1"
                    value="0"
                    class="w-full h-2 bg-black border border-gray-600"
                  />
                </div>
              </div>
            </div>
            <div class="flex justify-between items-end">
              <div class="flex gap-[2px]">
                <button id="btn-prev" class="win-btn w-8 h-8" title="Prev">
                  <i class="ph-fill ph-skip-back"></i>
                </button>
                <button id="btn-play" class="win-btn w-10 h-8" title="Play">
                  <i class="ph-fill ph-play text-base"></i>
                </button>
                <button id="btn-pause" class="win-btn w-10 h-8" title="Pause">
                  <i class="ph-fill ph-pause text-base"></i>
                </button>
                <button id="btn-stop" class="win-btn w-10 h-8" title="Stop">
                  <i class="ph-fill ph-stop text-base"></i>
                </button>
                <button id="btn-next" class="win-btn w-8 h-8" title="Next">
                  <i class="ph-fill ph-skip-forward"></i>
                </button>
              </div>
              <button
                id="btn-add-file"
                class="win-btn w-8 h-7 mb-[1px]"
                title="Open File"
              >
                <i class="ph-bold ph-eject"></i>
              </button>
              <div class="flex flex-col gap-1 justify-end">
                <button
                  id="tog-shuffle"
                  class="text-[9px] px-1 border border-gray-600 bg-black text-gray-500 w-12 text-center rounded-sm h-3 leading-none pt-[1px]"
                >
                  SHUFFLE
                </button>
                <button
                  id="tog-repeat"
                  class="text-[9px] px-1 border border-gray-600 bg-black text-gray-500 w-12 text-center rounded-sm h-3 leading-none pt-[1px]"
                >
                  REPEAT
                </button>
              </div>
            </div>
          </div>
        </div>

        <div
          class="bg-[#292929] border-t-2 border-l-2 border-gray-500 border-r-2 border-b-2 border-black relative z-10 shadow-lg"
        >
          <div
            class="h-4 bg-gradient-to-r from-gray-700 to-gray-800 flex justify-between items-center px-1 border-b border-black text-[10px] text-gray-300 font-bold cursor-pointer"
            onclick="toggleSection('eq-body')"
          >
            <span>EQUALIZER</span><i class="ph-bold ph-caret-down"></i>
          </div>
          <div id="eq-body" class="p-2 flex gap-2 h-[160px]">
            <div
              class="w-[85px] flex flex-col justify-between py-1 pr-1 border-r border-gray-600"
            >
              <select
                id="eq-preset-select"
                class="w-full text-[9px] bg-black text-win-green border border-gray-500 outline-none mb-2 h-4"
              >
                <option value="flat">Flat</option>
                <option value="rock">Rock</option>
                <option value="pop">Pop</option>
                <option value="jazz">Jazz</option>
                <option value="fullbass">Bass</option>
                <option value="custom">Manual</option>
              </select>
              <div class="space-y-[2px]">
                <div class="flex justify-between text-[8px] text-gray-400">
                  <span>PITCH</span>
                  <span id="val-pitch" class="text-win-gold">0</span>
                </div>
                <input
                  type="range"
                  data-key="semitones"
                  min="-12"
                  max="12"
                  step="1"
                  value="0"
                  class="w-full h-1 bg-gray-600"
                />
              </div>
              <div class="space-y-[2px]">
                <div class="flex justify-between text-[8px] text-gray-400">
                  <span>SPEED</span>
                  <span id="val-rate" class="text-win-gold">1.0</span>
                </div>
                <input
                  type="range"
                  data-key="rate"
                  min="0.5"
                  max="2"
                  step="0.05"
                  value="1"
                  class="w-full h-1 bg-gray-600"
                />
              </div>
            </div>
            <div class="flex-1 flex flex-col relative">
              <div
                class="flex items-center gap-2 mb-2 h-[35px] border border-gray-600 bg-black p-[2px]"
              >
                <button
                  id="btn-eq-toggle"
                  class="win-btn h-full w-12 text-[9px] flex flex-col gap-0 leading-none"
                >
                  <span>EQ</span>
                  <span id="txt-eq-status" class="text-[7px]">ON</span>
                </button>
                <canvas
                  id="eq-graph"
                  class="flex-1 h-full bg-[#111] border border-gray-800"
                  width="180"
                  height="30"
                ></canvas>
              </div>
              <div
                class="flex-1 flex gap-1 pb-1 px-1 bg-black border border-gray-600 shadow-inner relative"
                id="eq-container"
              ></div>
            </div>
          </div>
        </div>

        <div
          class="bg-[#292929] border-t-2 border-l-2 border-gray-500 border-r-2 border-b-2 border-black relative z-0 shadow-lg h-full"
        >
          <div
            class="h-4 bg-gradient-to-r from-gray-700 to-gray-800 flex justify-between items-center px-1 border-b border-black text-[10px] text-gray-300 font-bold"
          >
            <span>LIBRARY & PLAYLIST</span>
          </div>
          <div class="p-2 flex flex-col h-full relative">
            <div class="flex justify-between mb-1">
              <select
                id="playlist-select"
                class="bg-black text-win-green border border-gray-600 text-[10px] px-1 h-5 w-32 font-pixel focus:outline-none"
              >
                <option value="main">Main Library</option>
              </select>
              <div class="flex gap-1">
                <button
                  onclick="createNewPlaylist()"
                  class="win-btn px-2 h-5 text-[9px] font-bold shadow-sm"
                >
                  NEW
                </button>
                <button
                  onclick="handleDeletePlaylist()"
                  id="btn-del-pl"
                  class="win-btn px-2 h-5 text-[9px] font-bold text-red-900 shadow-sm hidden"
                  title="Delete Playlist"
                >
                  <i class="ph-bold ph-trash"></i>
                </button>
              </div>
            </div>

            <div
              class="flex-1 bg-black border-2 border-gray-600 border-r-white/50 border-b-white/50 overflow-y-auto custom-scroll p-1 font-pixel text-xs mb-2 shadow-inner select-none"
              id="pl-box"
            >
              <div class="text-gray-500 text-center mt-10 text-[10px]">
                Drop files or Click ADD...
              </div>
            </div>

            <div class="flex justify-between items-center h-6">
              <div class="flex gap-1">
                <button
                  id="btn-pl-add"
                  class="win-btn px-2 h-6 text-[10px] gap-1 font-bold shadow-sm"
                >
                  <i class="ph-bold ph-plus"></i> ADD
                </button>
                <button
                  onclick="handleDeleteTracks()"
                  id="btn-del-track"
                  class="win-btn px-2 h-6 text-[10px] gap-1 font-bold shadow-sm text-gray-500 cursor-default"
                  disabled
                >
                  <i class="ph-bold ph-minus"></i> REM
                </button>
                <button
                  onclick="openAddToModal()"
                  class="win-btn px-2 h-6 text-[10px] gap-1 font-bold shadow-sm"
                >
                  <i class="ph-bold ph-list-plus"></i> TO...
                </button>
                <button
                  onclick="moveTrack(-1)"
                  id="btn-move-up"
                  class="win-btn px-2 h-6 text-[10px] gap-1 font-bold shadow-sm text-gray-500 cursor-default"
                  disabled
                >
                  <i class="ph-bold ph-caret-up"></i>
                </button>
                <button
                  onclick="moveTrack(1)"
                  id="btn-move-down"
                  class="win-btn px-2 h-6 text-[10px] gap-1 font-bold shadow-sm text-gray-500 cursor-default"
                  disabled
                >
                  <i class="ph-bold ph-caret-down"></i>
                </button>
              </div>
              <div class="font-pixel text-win-green text-[10px]" id="pl-count">
                0 TRACKS
              </div>
            </div>
          </div>
        </div>

        <div
          id="modal-add-to"
          class="absolute inset-0 bg-black/80 z-50 flex items-center justify-center hidden"
        >
          <div class="bg-[#292929] border-2 border-white w-48 p-2 shadow-2xl">
            <div
              class="text-win-green font-pixel text-center mb-2 border-b border-gray-600 pb-1"
            >
              SELECT PLAYLIST
            </div>
            <div
              id="modal-list"
              class="flex flex-col gap-1 max-h-32 overflow-y-auto custom-scroll"
            ></div>
            <button
              onclick="closeAddToModal()"
              class="win-btn w-full mt-2 h-5 text-[9px]"
            >
              CANCEL
            </button>
          </div>
        </div>
      </div>
    </div>

    <input
      type="file"
      id="upload-file"
      hidden
      multiple
      accept="audio/*,.mp3,.wav,.m4a,.ogg"
    />

    <script type="module">
      import SignalsmithStretch from "https://cdn.jsdelivr.net/npm/signalsmith-stretch@latest/SignalsmithStretch.mjs";

      const $ = (s) => document.querySelector(s);
      const $$ = (s) => document.querySelectorAll(s);
      const STORAGE_KEY = "nextamp_settings_v1";

      // --- 0. SETTINGS PERSISTENCE ---
      function saveSettings() {
        const settings = {
          vol: $("#main-vol").value,
          bal: $("#main-bal").value,
          rate: controlValues.rate,
          pitch: controlValues.semitones,
          isShuffle: isShuffle,
          isRepeat: isRepeat,
          isEqOn: isEqOn,
          playlistId: currentPlaylistId,
          eqGains: eqNodes.map((n) => n.gain.value),
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(settings));
      }

      function loadSettings() {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return;
        const s = JSON.parse(raw);

        if (s.vol) {
          $("#main-vol").value = s.vol;
          masterGainNode.gain.value = parseFloat(s.vol);
          $("#txt-vol").textContent = Math.round(s.vol * 100) + "%";
        }
        if (s.bal) {
          $("#main-bal").value = s.bal;
          pannerNode.pan.value = parseFloat(s.bal);
        }
        if (s.rate) {
          controlValues.rate = parseFloat(s.rate);
          $('input[data-key="rate"]').value = s.rate;
          $("#val-rate").textContent = s.rate.toFixed(2);
        }
        if (s.pitch) {
          controlValues.semitones = parseFloat(s.pitch);
          $('input[data-key="semitones"]').value = s.pitch;
          $("#val-pitch").textContent = s.pitch;
        }

        if (s.isShuffle) {
          isShuffle = true;
          $("#tog-shuffle").classList.add("active-indicator");
        }
        if (s.isRepeat) {
          isRepeat = true;
          $("#tog-repeat").classList.add("active-indicator");
        }

        isEqOn = s.isEqOn !== undefined ? s.isEqOn : true;
        $("#txt-eq-status").textContent = isEqOn ? "ON" : "OFF";
        $("#btn-eq-toggle").classList.toggle("pressed", isEqOn);

        if (s.playlistId) currentPlaylistId = s.playlistId;

        window.savedEqGains = s.eqGains || [];
      }

      // --- 1. BOOT SEQUENCE & AUDIO UNLOCK ---
      const audioContext = new AudioContext();
      let isEngineHot = false;

      // Reverting to original file-based boot sequence
      const bootBtn = $("#btn-boot-start");
      const audioStartup = $("#audio-startup");
      const audioLoop = $("#audio-loop");

      // Connect Loop to Context (Standard Bridge for Background Play)
      const loopSource = audioContext.createMediaElementSource(audioLoop);
      loopSource.connect(audioContext.destination);

      bootBtn.onclick = async () => {
        try {
          audioStartup.volume = 0.5;
          audioLoop.volume = 0.2; // Original volume request

          if (audioContext.state === "suspended") {
            await audioContext.resume();
          }

          // Play both immediately
          await audioStartup.play();
          audioLoop
            .play()
            .catch((e) => console.warn("Loop playback warning:", e));

          audioStartup.onended = () => {
            enterApp();
          };

          // Fallback
          audioStartup.onerror = () => enterApp();
        } catch (e) {
          console.error("Audio unlock failed:", e);
          enterApp();
        }
      };

      function enterApp() {
        if (isEngineHot) return;
        isEngineHot = true;
        $("#engine-status").style.backgroundColor = "#00ff00";
        $("#engine-status").style.boxShadow = "0 0 4px #0f0";

        $("#boot-screen").style.opacity = "0";
        $("#boot-screen").style.transition = "opacity 0.5s";
        setTimeout(() => $("#boot-screen").classList.add("hidden"), 500);
      }

      async function wakeUpAudioEngine() {
        if (isEngineHot) return;
        try {
          await audioContext.resume();
          isEngineHot = true;
          $("#engine-status").style.backgroundColor = "#00ff00";
          $("#engine-status").style.boxShadow = "0 0 4px #0f0";

          if (audioLoop.paused) {
            audioLoop.play().catch((e) => {});
          }
        } catch (e) {
          console.error(e);
        }
      }

      // Media Session Handler
      function updateMediaSession(trackName) {
        if ("mediaSession" in navigator) {
          navigator.mediaSession.metadata = new MediaMetadata({
            title: trackName,
            artist: "Nextamp Player",
            album: "My Playlist",
            artwork: [
              {
                src: "https://cdn-icons-png.flaticon.com/512/3669/3669986.png",
                sizes: "512x512",
                type: "image/png",
              },
            ],
          });
          navigator.mediaSession.setActionHandler("play", () =>
            $("#btn-play").click()
          );
          navigator.mediaSession.setActionHandler("pause", () =>
            $("#btn-pause").click()
          );
          navigator.mediaSession.setActionHandler("previoustrack", () =>
            $("#btn-prev").click()
          );
          navigator.mediaSession.setActionHandler("nexttrack", () =>
            $("#btn-next").click()
          );
        }
      }

      // --- 2. CORE ENGINE ---
      let stretch = null;
      let eqNodes = [];
      let analyser = audioContext.createAnalyser();
      let masterGainNode = audioContext.createGain();
      let pannerNode = audioContext.createStereoPanner();
      let audioDuration = 1;
      let isChangingTrack = false;

      analyser.connect(pannerNode);
      pannerNode.connect(masterGainNode);
      masterGainNode.connect(audioContext.destination);

      masterGainNode.gain.value = 0.8;
      analyser.fftSize = 256;

      const FREQUENCIES = [
        60, 170, 310, 600, 1000, 3000, 6000, 12000, 14000, 16000,
      ];
      const PRESETS = {
        flat: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        rock: [4, 3, 2, 0, -1, -1, 0, 2, 3, 4],
        pop: [-1, 1, 3, 3, 1, -1, -2, -2, -1, -1],
        jazz: [3, 2, 0, -2, -2, 0, 2, 3, 4, 4],
        fullbass: [6, 6, 5, 2, 0, -2, -4, -5, -6, -6],
      };

      let controlValues = { active: false, rate: 1, semitones: 0 };
      let isEqOn = true;

      function initEQ() {
        eqNodes.forEach((n) => {
          try {
            n.disconnect();
          } catch (e) {}
        });
        eqNodes = [];
        let prev = null;
        let first = null;
        FREQUENCIES.forEach((freq, i) => {
          const f = audioContext.createBiquadFilter();
          f.type = "peaking";
          f.frequency.value = freq;
          f.Q.value = 1.4;

          let savedVal =
            window.savedEqGains && window.savedEqGains[i] !== undefined
              ? window.savedEqGains[i]
              : 0;
          const slider = document.querySelector(`input[data-idx="${i}"]`);
          if (slider) {
            slider.value = savedVal;
            updateThumb(slider, `thumb-${i}`);
          }

          f.gain.value = isEqOn ? savedVal : 0;
          eqNodes.push(f);
          if (prev) prev.connect(f);
          else first = f;
          prev = f;
        });
        return { input: first, output: prev };
      }

      async function loadAudioEngine(arrayBuffer) {
        if (audioContext.state === "suspended") await wakeUpAudioEngine();

        const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
        audioDuration = audioBuffer.duration;
        const channelBuffers = [];
        for (let c = 0; c < audioBuffer.numberOfChannels; ++c)
          channelBuffers.push(audioBuffer.getChannelData(c));

        if (stretch) {
          stretch.stop();
          stretch.disconnect();
        }
        stretch = await SignalsmithStretch(audioContext);
        const eqChain = initEQ();
        stretch.connect(eqChain.input);
        eqChain.output.connect(analyser);
        await stretch.addBuffers(channelBuffers);
        controlValues.active = true;
        controlsChanged();
        isChangingTrack = false;
      }

      function controlsChanged(scheduleAhead) {
        $("#btn-play").classList.toggle("pressed", controlValues.active);
        if (stretch) {
          let obj = Object.assign(
            { output: audioContext.currentTime + (scheduleAhead || 0) },
            controlValues
          );
          stretch.schedule(obj);
        }
      }

      // --- 3. DATA LAYER ---
      let LIBRARY = [];
      let playlists = { main: { name: "Main Library", trackIds: [] } };
      let currentPlaylistId = "main";
      let currentTrackIndex = -1;
      let selectedIndices = new Set();
      let lastSelectedIndex = -1;

      const DB_NAME = "NextampUltimateDB";
      const dbReq = indexedDB.open(DB_NAME, 8);

      dbReq.onupgradeneeded = (e) => {
        const db = e.target.result;
        if (!db.objectStoreNames.contains("library"))
          db.createObjectStore("library", { keyPath: "id" });
        if (!db.objectStoreNames.contains("playlists"))
          db.createObjectStore("playlists", { keyPath: "id" });
      };

      dbReq.onsuccess = async (e) => {
        await loadLibraryFromDB();
        await loadPlaylistsFromDB();
        loadSettings();
        renderPlaylistSelect();
        renderPlaylistUI();
        initEQ();
        drawEQCurve();
      };

      async function saveTrackToLib(track) {
        const db = dbReq.result;
        const tx = db.transaction("library", "readwrite");
        tx.objectStore("library").put(track);
      }
      async function deleteTrackFromLib(id) {
        const db = dbReq.result;
        const tx = db.transaction("library", "readwrite");
        tx.objectStore("library").delete(id);
      }
      async function savePlaylistsToDB(plObj) {
        const db = dbReq.result;
        const tx = db.transaction("playlists", "readwrite");
        tx.objectStore("playlists").put(plObj);
      }
      async function loadLibraryFromDB() {
        return new Promise((resolve) => {
          const db = dbReq.result;
          const tx = db.transaction("library", "readonly");
          const req = tx.objectStore("library").getAll();
          req.onsuccess = () => {
            LIBRARY = req.result || [];
            resolve();
          };
        });
      }
      async function loadPlaylistsFromDB() {
        return new Promise((resolve) => {
          const db = dbReq.result;
          const tx = db.transaction("playlists", "readonly");
          const req = tx.objectStore("playlists").getAll();
          req.onsuccess = () => {
            if (req.result && req.result.length)
              req.result.forEach((p) => (playlists[p.id] = p));
            resolve();
          };
        });
      }

      const getTrackById = (id) => LIBRARY.find((t) => t.id === id);
      function getCurrentDisplayList() {
        if (currentPlaylistId === "main") return LIBRARY;
        return playlists[currentPlaylistId].trackIds
          .map((id) => getTrackById(id))
          .filter((t) => t);
      }

      // --- 4. CONTROLS ---
      async function playTrack(idx) {
        if (isChangingTrack) return;
        isChangingTrack = true;
        if (!isEngineHot) await wakeUpAudioEngine();
        let list = getCurrentDisplayList();
        if (idx < 0 || idx >= list.length) {
          isChangingTrack = false;
          return;
        }

        currentTrackIndex = idx;
        renderPlaylistUI();
        const t = list[idx];
        $("#marquee").textContent = `${idx + 1}. ${t.name} - Buffering...`;

        try {
          const buf = await t.blob.arrayBuffer();
          await loadAudioEngine(buf);
          $("#marquee").textContent = `${idx + 1}. ${t.name} (${
            t.sampleRate || 44100
          }hz)`;
          updateMediaSession(t.name);
        } catch (e) {
          console.error(e);
          $("#marquee").textContent = "Error loading file.";
          isChangingTrack = false;
        }
      }

      function handleNextTrack(auto = false) {
        let list = getCurrentDisplayList();
        if (list.length === 0) return;
        let next;
        if (isShuffle) {
          if (list.length > 1) {
            do {
              next = Math.floor(Math.random() * list.length);
            } while (next === currentTrackIndex);
          } else {
            next = 0;
          }
        } else {
          next = currentTrackIndex + 1;
        }

        if (next < list.length) playTrack(next);
        else if (isRepeat) playTrack(0);
        else if (!auto) playTrack(0);
      }

      function handlePrevTrack() {
        let list = getCurrentDisplayList();
        if (list.length === 0) return;
        let prev = isShuffle
          ? Math.floor(Math.random() * list.length)
          : currentTrackIndex - 1;
        if (prev < 0) prev = isRepeat ? list.length - 1 : 0;
        playTrack(prev);
      }

      $("#btn-play").onclick = async () => {
        if (!isEngineHot) await wakeUpAudioEngine();
        const list = getCurrentDisplayList();
        if (!stretch && list.length > 0)
          playTrack(Math.max(0, currentTrackIndex));
        else if (stretch) {
          controlValues.active = !controlValues.active;
          controlsChanged(0.1);
        }
      };
      $("#btn-pause").onclick = () => {
        controlValues.active = false;
        controlsChanged();
      };
      $("#btn-stop").onclick = () => {
        controlValues.active = false;
        if (stretch) stretch.stop();
        $("#playback").value = 0;
        $("#time-display").textContent = "00:00";
        $("#btn-play").classList.remove("pressed");
        $("#marquee").textContent = "Stopped.";
      };
      $("#btn-next").onclick = () => handleNextTrack(false);
      $("#btn-prev").onclick = () => handlePrevTrack();

      // --- 5. UI & EQ ---
      const eqContainer = $("#eq-container");
      const eqCanvas = $("#eq-graph");
      const eqCtx = eqCanvas.getContext("2d");
      $("#btn-eq-toggle").onclick = () => {
        isEqOn = !isEqOn;
        $("#txt-eq-status").textContent = isEqOn ? "ON" : "OFF";
        $("#btn-eq-toggle").classList.toggle("pressed", isEqOn);
        $$("input[data-idx]").forEach((inp, i) => updateEqBand(i, inp.value));
        saveSettings();
      };
      FREQUENCIES.forEach((f, i) => {
        const div = document.createElement("div");
        div.className =
          "flex flex-col items-center h-full flex-1 group relative";
        div.innerHTML = `<div class="relative h-full w-full flex justify-center pt-2 pb-3"><div class="eq-bar-bg ${
          isEqOn ? "eq-bar-active" : ""
        }" id="eq-bg-${i}"></div><div class="eq-thumb" style="top: 50%" id="thumb-${i}"></div><input type="range" class="vertical" min="-12" max="12" step="0.5" value="0" data-idx="${i}" title="${f}Hz" oninput="updateEqBand(${i}, this.value); updateThumb(this, 'thumb-${i}')"></div><div class="absolute -bottom-1 text-[7px] text-win-green font-pixel tracking-tighter">${
          f >= 1000 ? f / 1000 + "k" : f
        }</div>`;
        div.querySelector("input").ondblclick = (e) => {
          e.target.value = 0;
          updateEqBand(i, 0);
          updateThumb(e.target, `thumb-${i}`);
        };
        eqContainer.appendChild(div);
      });
      window.updateThumb = (input, thumbId) => {
        const min = parseFloat(input.min),
          max = parseFloat(input.max),
          val = parseFloat(input.value);
        const topPos = 100 - ((val - min) / (max - min)) * 100;
        $(`#${thumbId}`).style.top = `${topPos}%`;
      };
      window.updateEqBand = (idx, val) => {
        if (eqNodes[idx])
          eqNodes[idx].gain.value = isEqOn ? parseFloat(val) : 0;
        const bg = $(`#eq-bg-${idx}`);
        if (isEqOn) bg.classList.add("eq-bar-active");
        else bg.classList.remove("eq-bar-active");
        drawEQCurve();
        saveSettings();
      };
      function drawEQCurve() {
        eqCtx.clearRect(0, 0, eqCanvas.width, eqCanvas.height);
        eqCtx.strokeStyle = "#333";
        eqCtx.lineWidth = 1;
        eqCtx.beginPath();
        eqCtx.moveTo(0, 15);
        eqCtx.lineTo(180, 15);
        eqCtx.stroke();
        if (!isEqOn) return;
        eqCtx.strokeStyle = "#00ff00";
        eqCtx.lineWidth = 2;
        eqCtx.beginPath();
        const stepX = eqCanvas.width / (FREQUENCIES.length - 1);
        const points = [];
        FREQUENCIES.forEach((_, i) => {
          let gain = 0;
          if (eqNodes[i]) gain = eqNodes[i].gain.value;
          else {
            const inp = $(`input[data-idx="${i}"]`);
            gain = inp ? parseFloat(inp.value) : 0;
          }
          points.push({ x: i * stepX, y: 15 - gain * (15 / 14) });
        });
        eqCtx.moveTo(points[0].x, points[0].y);
        for (let i = 1; i < points.length - 2; i++) {
          const xc = (points[i].x + points[i + 1].x) / 2;
          const yc = (points[i].y + points[i + 1].y) / 2;
          eqCtx.quadraticCurveTo(points[i].x, points[i].y, xc, yc);
        }
        eqCtx.quadraticCurveTo(
          points[points.length - 2].x,
          points[points.length - 2].y,
          points[points.length - 1].x,
          points[points.length - 1].y
        );
        eqCtx.stroke();
      }
      $("#eq-preset-select").onchange = (e) => {
        const val = e.target.value;
        if (PRESETS[val]) {
          PRESETS[val].forEach((v, i) => {
            const inp = $(`input[data-idx="${i}"]`);
            inp.value = v;
            updateThumb(inp, `thumb-${i}`);
            updateEqBand(i, v);
          });
        }
      };

      const cvs = $("#visualizer"),
        ctx = cvs.getContext("2d");
      function resizeCvs() {
        const r = cvs.parentElement.getBoundingClientRect();
        cvs.width = r.width;
        cvs.height = r.height;
      }
      window.addEventListener("resize", resizeCvs);
      setTimeout(resizeCvs, 500);

      function draw() {
        requestAnimationFrame(draw);

        // --- UPDATE LOCK SCREEN PROGRESS ---
        if ("mediaSession" in navigator && stretch && controlValues.active) {
          try {
            navigator.mediaSession.setPositionState({
              duration: audioDuration || 0,
              playbackRate: controlValues.rate || 1,
              position: stretch.inputTime || 0,
            });
          } catch (error) {
            // Ignore errors
          }
        }

        if (stretch && !holding) {
          const pb = $("#playback");
          pb.max = audioDuration;
          const t = stretch.inputTime || 0;
          pb.value = t;
          $("#time-display").textContent = `${Math.floor(t / 60)}:${Math.floor(
            t % 60
          )
            .toString()
            .padStart(2, "0")}`;

          if (
            controlValues.active &&
            t >= audioDuration - 0.2 &&
            !isChangingTrack
          ) {
            handleNextTrack(true);
          }
        }
        const bufferLength = analyser.frequencyBinCount;
        const dataArray = new Uint8Array(bufferLength);
        analyser.getByteFrequencyData(dataArray);
        ctx.fillStyle = "#111";
        ctx.fillRect(0, 0, cvs.width, cvs.height);
        let gradient = ctx.createLinearGradient(0, cvs.height, 0, 0);
        gradient.addColorStop(0, "#00ff00");
        gradient.addColorStop(0.6, "#ffff00");
        gradient.addColorStop(1, "#ff0000");
        ctx.fillStyle = gradient;
        const barWidth = (cvs.width / bufferLength) * 2.5;
        let x = 0;
        for (let i = 0; i < bufferLength; i++) {
          let barHeight = (dataArray[i] / 255) * cvs.height;
          if (barHeight > 0)
            ctx.fillRect(x, cvs.height - barHeight, barWidth - 1, barHeight);
          x += barWidth;
        }
      }
      draw();

      // --- 6. PLAYLIST UI ---
      $("#pl-box").onclick = (e) => {
        if (
          e.target.id === "pl-box" ||
          e.target.classList.contains("text-center")
        ) {
          selectedIndices.clear();
          renderPlaylistUI();
        }
      };

      window.renderPlaylistUI = () => {
        const box = $("#pl-box");
        box.innerHTML = "";
        let displayList = getCurrentDisplayList();
        if (displayList.length === 0) {
          box.innerHTML = `<div class="text-gray-500 text-center mt-10 text-[10px] pointer-events-none">${
            currentPlaylistId === "main"
              ? "Drop files or Click ADD..."
              : "Playlist empty."
          }</div>`;
        } else {
          displayList.forEach((t, i) => {
            const d = document.createElement("div");
            let bgClass = selectedIndices.has(i)
              ? "bg-[#000080] text-white"
              : "text-win-green hover:bg-[#222]";
            let textClass = i === currentTrackIndex ? "font-bold" : "";
            d.className = `cursor-pointer px-1 flex justify-between select-none ${bgClass} ${textClass}`;
            d.draggable = true;
            d.innerHTML = `<div class="flex truncate w-full pointer-events-none"><span class="w-6 text-right mr-2 flex-shrink-0">${
              i + 1
            }.</span><span class="truncate">${t.name}</span></div>`;

            d.ondragstart = (e) => {
              e.dataTransfer.setData("text/plain", i);
              d.classList.add("dragging");
            };
            d.ondragend = () => d.classList.remove("dragging");
            d.ondragover = (e) => {
              e.preventDefault();
              d.classList.add("drag-over");
            };
            d.ondragleave = () => d.classList.remove("drag-over");
            d.ondrop = (e) => {
              e.preventDefault();
              d.classList.remove("drag-over");
              handleDragDrop(parseInt(e.dataTransfer.getData("text/plain")), i);
            };

            d.onclick = (e) => {
              e.stopPropagation();
              if (e.shiftKey && lastSelectedIndex !== -1) {
                const start = Math.min(lastSelectedIndex, i);
                const end = Math.max(lastSelectedIndex, i);
                selectedIndices.clear();
                for (let k = start; k <= end; k++) selectedIndices.add(k);
              } else if (e.ctrlKey || e.metaKey) {
                selectedIndices.has(i)
                  ? selectedIndices.delete(i)
                  : selectedIndices.add(i);
                lastSelectedIndex = i;
              } else {
                selectedIndices.clear();
                selectedIndices.add(i);
                lastSelectedIndex = i;
              }
              renderPlaylistUI();
            };
            d.ondblclick = () => playTrack(i);
            box.appendChild(d);
          });
        }
        $("#pl-count").textContent = `${displayList.length} TRACKS`;

        const hasSel = selectedIndices.size > 0;

        const toggleDisableStyle = (btnId, isDisabled) => {
          const btn = $(btnId);
          btn.disabled = isDisabled;
          if (isDisabled) {
            btn.classList.add("text-gray-500", "cursor-default");
            btn.classList.remove(
              "text-red-900",
              "text-black",
              "cursor-pointer"
            );
          } else {
            btn.classList.remove("text-gray-500", "cursor-default");
            btn.classList.add("cursor-pointer");
            if (btnId === "#btn-del-track") btn.classList.add("text-red-900");
            else btn.classList.add("text-black");
          }
        };

        toggleDisableStyle("#btn-del-track", !hasSel);
        toggleDisableStyle("#btn-move-up", !hasSel);
        toggleDisableStyle("#btn-move-down", !hasSel);

        $("#btn-del-pl").style.display =
          currentPlaylistId === "main" ? "none" : "block";
      };

      window.moveTrack = (dir) => {
        if (selectedIndices.size !== 1) return;
        const idx = Array.from(selectedIndices)[0];
        const newIdx = idx + dir;
        handleDragDrop(idx, newIdx);
      };

      window.handleDragDrop = async (srcIdx, targetIdx) => {
        let list = getCurrentDisplayList();
        if (targetIdx < 0 || targetIdx >= list.length || srcIdx === targetIdx)
          return;
        const item = list.splice(srcIdx, 1)[0];
        list.splice(targetIdx, 0, item);

        if (currentTrackIndex === srcIdx) currentTrackIndex = targetIdx;
        else if (currentTrackIndex === targetIdx && srcIdx > targetIdx)
          currentTrackIndex++;
        else if (currentTrackIndex === targetIdx && srcIdx < targetIdx)
          currentTrackIndex--;

        if (currentPlaylistId !== "main") {
          playlists[currentPlaylistId].trackIds = list.map((t) => t.id);
          await savePlaylistsToDB(playlists[currentPlaylistId]);
        }
        selectedIndices.clear();
        selectedIndices.add(targetIdx);
        renderPlaylistUI();
      };

      window.handleDeleteTracks = async () => {
        if (selectedIndices.size === 0) return;
        if (confirm(`Remove ${selectedIndices.size} selected track(s)?`)) {
          const indices = Array.from(selectedIndices).sort((a, b) => b - a);
          if (currentPlaylistId === "main") {
            const list = getCurrentDisplayList();
            for (let i of indices) {
              await deleteTrackFromLib(list[i].id);
              LIBRARY.splice(i, 1);
            }
          } else {
            const pl = playlists[currentPlaylistId];
            for (let i of indices) pl.trackIds.splice(i, 1);
            await savePlaylistsToDB(pl);
          }
          selectedIndices.clear();
          renderPlaylistUI();
        }
      };

      window.handleDeletePlaylist = () => {
        if (currentPlaylistId === "main") return;
        if (
          confirm(`Delete playlist "${playlists[currentPlaylistId].name}"?`)
        ) {
          delete playlists[currentPlaylistId];
          const db = dbReq.result;
          const tx = db.transaction("playlists", "readwrite");
          tx.objectStore("playlists").delete(currentPlaylistId);
          switchPlaylist("main");
          renderPlaylistSelect();
        }
      };

      const fileInput = $("#upload-file");
      $("#btn-add-file").onclick = () => fileInput.click();
      $("#btn-pl-add").onclick = () => fileInput.click();
      fileInput.onchange = (e) => handleFiles(e.target.files);
      document.body.ondragover = (e) => e.preventDefault();
      document.body.ondrop = (e) => {
        e.preventDefault();
        handleFiles(e.dataTransfer.files);
      };

      async function handleFiles(files) {
        if (!isEngineHot) await wakeUpAudioEngine();
        for (const f of files) {
          const id = "t_" + Date.now() + Math.random();
          const obj = { id, name: f.name, blob: f };
          LIBRARY.push(obj);
          await saveTrackToLib(obj);
          if (currentPlaylistId !== "main") {
            playlists[currentPlaylistId].trackIds.push(id);
            await savePlaylistsToDB(playlists[currentPlaylistId]);
          }
        }
        renderPlaylistUI();
      }

      window.createNewPlaylist = () => {
        const n = prompt("Playlist Name:");
        if (n && n.trim().length > 0) {
          const id = "pl_" + Date.now();
          playlists[id] = { id, name: n.trim(), trackIds: [] };
          savePlaylistsToDB(playlists[id]);
          renderPlaylistSelect();
          switchPlaylist(id);
        }
      };
      window.switchPlaylist = (id) => {
        currentPlaylistId = id;
        $("#playlist-select").value = id;
        selectedIndices.clear();
        renderPlaylistUI();
        saveSettings();
      };
      window.renderPlaylistSelect = () => {
        const s = $("#playlist-select");
        s.innerHTML = '<option value="main">Main Library</option>';
        Object.keys(playlists)
          .filter((k) => k !== "main")
          .forEach((k) => {
            const o = document.createElement("option");
            o.value = k;
            o.textContent = playlists[k].name;
            s.appendChild(o);
          });
        s.value = currentPlaylistId;
      };
      $("#playlist-select").onchange = (e) => switchPlaylist(e.target.value);
      window.openAddToModal = () => {
        if (!selectedIndices.size) return alert("Select tracks first");
        const d = $("#modal-list");
        d.innerHTML = "";
        Object.keys(playlists)
          .filter((k) => k !== "main")
          .forEach((k) => {
            const b = document.createElement("button");
            b.className =
              "w-full text-left px-2 py-1 text-[10px] text-gray-300 hover:bg-win-green hover:text-black font-pixel border border-gray-600 mb-1";
            b.textContent = playlists[k].name;
            b.onclick = () => {
              const list = getCurrentDisplayList();
              const ids = Array.from(selectedIndices).map((i) => list[i].id);
              playlists[k].trackIds.push(...ids);
              savePlaylistsToDB(playlists[k]);
              closeAddToModal();
              selectedIndices.clear();
              renderPlaylistUI();
            };
            d.appendChild(b);
          });
        $("#modal-add-to").classList.remove("hidden");
      };
      window.closeAddToModal = () => $("#modal-add-to").classList.add("hidden");

      const pb = $("#playback");
      let holding = false;
      pb.onmousedown = pb.ontouchstart = () => (holding = true);
      pb.onmouseup = pb.ontouchend = () => {
        holding = false;
        if (stretch)
          stretch.schedule({
            input: parseFloat(pb.value),
            rate: controlValues.rate,
            semitones: controlValues.semitones,
          });
      };
      pb.oninput = () => {
        if (!stretch) return;
        stretch.schedule({ input: parseFloat(pb.value), rate: 0 });
      };
      $("#main-vol").oninput = (e) => {
        masterGainNode.gain.value = parseFloat(e.target.value);
        $("#txt-vol").textContent = Math.round(e.target.value * 100) + "%";
        saveSettings();
      };
      $("#main-bal").oninput = (e) => {
        pannerNode.pan.value = parseFloat(e.target.value);
        saveSettings();
      };
      $('[data-key="rate"]').oninput = (e) => {
        controlValues.rate = parseFloat(e.target.value);
        $("#val-rate").textContent = controlValues.rate.toFixed(2);
        controlsChanged();
        saveSettings();
      };
      $('[data-key="semitones"]').oninput = (e) => {
        controlValues.semitones = parseFloat(e.target.value);
        $("#val-pitch").textContent = controlValues.semitones;
        controlsChanged();
        saveSettings();
      };

      let isShuffle = false,
        isRepeat = false;
      $("#tog-shuffle").onclick = function () {
        isShuffle = !isShuffle;
        this.classList.toggle("active-indicator", isShuffle);
        saveSettings();
      };
      $("#tog-repeat").onclick = function () {
        isRepeat = !isRepeat;
        this.classList.toggle("active-indicator", isRepeat);
        saveSettings();
      };
      window.toggleSection = (id) => $(`#${id}`).classList.toggle("hidden");

      // --- PWA INSTALL HANDLER ---
      let deferredPrompt;
      window.addEventListener("beforeinstallprompt", (e) => {
        e.preventDefault();
        deferredPrompt = e;
        $("#btn-install-pwa").classList.remove("hidden");
      });
      $("#btn-install-pwa").onclick = async () => {
        $("#btn-install-pwa").classList.add("hidden");
        if (deferredPrompt) {
          deferredPrompt.prompt();
          const { outcome } = await deferredPrompt.userChoice;
          console.log(`User response to install prompt: ${outcome}`);
          deferredPrompt = null;
        }
      };

      setInterval(() => {
        if (stretch && controlValues.active && !holding && !isChangingTrack) {
          const t = stretch.inputTime || 0;
          if (t >= audioDuration - 0.2) {
            handleNextTrack(true);
          }
        }
      }, 1000);
    </script>
  </body>
</html>
