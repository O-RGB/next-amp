<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"
    />
    <title>Nextamp Remote</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
      :root {
        --theme-window: #000080;
        --theme-text: #00ff00;
        --theme-text-sec: #ffcc00;
      }

      body {
        background: radial-gradient(circle at center, #003504 0%, #020617 80%);
        color: #e5e5e5;
        font-family: "Chakra Petch", sans-serif;
        height: 100vh;
        width: 100vw;
        overflow: hidden;
        user-select: none;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      /* Win98 Button Style from app.html */
      .win-btn {
        background-color: #c0c0c0;
        color: black;
        border-top: 2px solid #fff;
        border-left: 2px solid #fff;
        border-right: 2px solid #000;
        border-bottom: 2px solid #000;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 11px;
        font-weight: bold;
        transition: all 0.1s;
      }
      .win-btn:active {
        border-top: 2px solid #000;
        border-left: 2px solid #000;
        border-right: 2px solid #fff;
        border-bottom: 2px solid #fff;
        transform: translate(1px, 1px);
      }
      .win-btn:disabled {
        color: #888;
        cursor: not-allowed;
        transform: none;
        border-color: #555;
      }

      /* Containers */
      .win-box {
        background-color: #292929;
        border-top: 2px solid #888;
        border-left: 2px solid #888;
        border-right: 2px solid #000;
        border-bottom: 2px solid #000;
        box-shadow: 0 0 20px rgba(0, 255, 0, 0.1);
      }

      .theme-bar {
        background-color: var(--theme-window);
        color: white;
        font-size: 10px;
        font-weight: bold;
        padding: 2px 4px;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .inset-panel {
        background-color: black;
        border: 2px solid #444;
        border-right-color: #fff;
        border-bottom-color: #fff;
        color: var(--theme-text);
      }

      /* Scrollbar */
      .custom-scroll::-webkit-scrollbar {
        width: 8px;
        background: #292929;
      }
      .custom-scroll::-webkit-scrollbar-thumb {
        background: #c0c0c0;
        border: 1px solid #fff;
        border-right: 1px solid #000;
        border-bottom: 1px solid #000;
      }

      .track-item:hover {
        background-color: #222;
        color: white;
      }

      /* Progress Bar Block Style */
      .progress-block {
        background: repeating-linear-gradient(
          90deg,
          #00ff00,
          #00ff00 4px,
          #000 4px,
          #000 5px
        );
      }
    </style>
  </head>
  <body>
    <div class="win-box w-full max-w-sm flex flex-col relative z-10">
      <div class="theme-bar h-6 border-b border-black">
        <div class="flex items-center gap-1">
          <i class="ph-bold ph-broadcast text-xs"></i>
          <span>REMOTE UPLOAD</span>
        </div>
        <div
          id="connection-status"
          class="text-[9px] font-mono uppercase bg-black px-1 border border-gray-600 text-yellow-500"
        >
          Connecting...
        </div>
      </div>

      <div class="p-3 flex flex-col gap-3">
        <div id="main-interface" class="flex flex-col gap-2 hidden">
          <input
            type="file"
            id="file-input"
            accept="audio/*,.mp3,.wav,.m4a,.ogg"
            multiple
            class="hidden"
          />

          <div class="grid grid-cols-2 gap-2">
            <button
              id="btn-select"
              onclick="document.getElementById('file-input').click()"
              class="win-btn h-12 flex flex-col gap-0.5 shadow-lg"
            >
              <i class="ph-bold ph-folder-open text-base"></i>
              <span class="text-[9px]">LOCAL FILES</span>
            </button>
            <button
              id="btn-library"
              onclick="openLibraryModal()"
              class="win-btn h-12 flex flex-col gap-0.5 shadow-lg"
            >
              <i class="ph-bold ph-database text-base"></i>
              <span class="text-[9px]">LIBRARY</span>
            </button>
          </div>

          <div
            id="queue-info"
            class="text-[9px] text-gray-400 font-bold hidden flex justify-between px-1"
          >
            <span>TRANSFER QUEUE</span>
            <span id="queue-count" class="text-white">0/0</span>
          </div>

          <div id="progress-area" class="hidden">
            <div class="bg-black border border-gray-600 p-1 mb-1">
              <div
                class="flex justify-between text-[9px] font-mono text-green-500 mb-0.5"
              >
                <span id="filename-disp" class="truncate max-w-[150px]"
                  >...</span
                >
                <span id="percent-disp">0%</span>
              </div>
              <div class="w-full h-3 bg-[#111] border border-gray-700 relative">
                <div
                  id="progress-bar"
                  class="h-full bg-green-600 w-0 transition-all duration-75"
                ></div>
                <div
                  class="absolute inset-0 bg-[url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAQAAAAECAYAAACp8Z5+AAAAIklEQVQIW2NkQAKrVq36zwjjgzjwqgABXA0UBVYJIoAFCAwAVkIgE+q02bwAAAAASUVORK5CYII=')] opacity-30"
                ></div>
              </div>
            </div>
            <div
              class="text-[9px] text-gray-500 text-center"
              id="status-detail"
            >
              Waiting...
            </div>
          </div>
        </div>
      </div>

      <div class="bg-[#292929] p-1 border-t border-gray-500 text-center">
        <div class="text-[8px] text-gray-500 font-mono">
          NEXTAMP V2.1 REMOTE
        </div>
      </div>
    </div>

    <div
      id="lib-modal"
      class="absolute inset-0 z-50 flex items-center justify-center bg-black/80 hidden"
    >
      <div
        class="bg-[#292929] border-2 border-white w-72 shadow-2xl flex flex-col h-[80vh]"
      >
        <div class="theme-bar px-2 py-1 mb-1 border-b border-black">
          <span>SELECT TRACKS</span>
          <button
            onclick="closeLibraryModal()"
            class="hover:text-red-500 text-xs"
          >
            <i class="ph-bold ph-x"></i>
          </button>
        </div>

        <div class="px-2 pt-2 pb-1 bg-[#292929]">
          <div class="flex gap-1 mb-1">
            <select
              id="playlist-select"
              onchange="handlePlaylistChange()"
              class="w-full bg-black text-green-500 border border-gray-600 text-[10px] p-1 h-6 focus:outline-none font-mono"
            >
              <option value="main">Main Library</option>
            </select>
          </div>
        </div>

        <div class="flex-1 px-2 pb-2 min-h-0 flex flex-col">
          <div
            class="flex-1 bg-black border-2 border-gray-600 border-r-white/50 border-b-white/50 overflow-y-auto custom-scroll p-1 font-mono text-[10px] shadow-inner select-none relative"
            id="lib-list"
          >
            <div class="text-gray-500 text-center mt-10">Loading DB...</div>
          </div>

          <div
            class="flex justify-between items-center mt-1 text-[9px] text-gray-400 font-mono px-1"
          >
            <span id="lib-count-disp">SEL: 0/10</span>
          </div>
        </div>

        <div class="p-2 border-t border-gray-600 bg-[#292929] flex gap-2">
          <button
            onclick="closeLibraryModal()"
            class="win-btn flex-1 h-6 text-[10px]"
          >
            CANCEL
          </button>
          <button
            onclick="confirmLibrarySelection()"
            class="win-btn flex-1 h-6 text-[10px] text-green-900 font-bold border-green-900/30"
          >
            SEND
          </button>
        </div>
      </div>
    </div>

    <script>
      // CONFIG
      const CHUNK_SIZE = 16 * 1024;
      const SYNC_INTERVAL = 20;
      const LIMIT_MAX_FILES = 10;
      const LIMIT_MAX_SIZE_MB = 100;
      const DB_NAME = "NextampUltimateDB";

      const params = new URLSearchParams(window.location.search);
      const hostId = params.get("host");

      const statusEl = document.getElementById("connection-status");
      const mainInterface = document.getElementById("main-interface");
      const btnSelect = document.getElementById("btn-select");
      const btnLibrary = document.getElementById("btn-library");
      const progressArea = document.getElementById("progress-area");

      let peer = null,
        conn = null;
      let fileQueue = [],
        totalFiles = 0;
      let isProcessing = false;

      let dbLibrary = [];
      let dbPlaylists = {};
      let currentLibView = [];

      let resolveUpload = null;
      let resolveSync = null;

      if (!hostId) {
        statusEl.innerText = "NO ID";
        statusEl.className =
          "text-[9px] font-mono uppercase bg-black px-1 border border-gray-600 text-red-500";
        throw new Error("No Host ID");
      }

      peer = new Peer();

      peer.on("open", (id) => {
        statusEl.innerText = "CONNECTING...";
        conn = peer.connect(hostId, { reliable: true });

        conn.on("open", () => {
          statusEl.innerText = "CONNECTED";
          statusEl.className =
            "text-[9px] font-mono uppercase bg-black px-1 border border-gray-600 text-[#00ff00]";
          mainInterface.classList.remove("hidden");
        });

        conn.on("close", () => {
          statusEl.innerText = "OFFLINE";
          statusEl.className =
            "text-[9px] font-mono uppercase bg-black px-1 border border-gray-600 text-red-500";
          btnSelect.disabled = true;
          btnLibrary.disabled = true;
          mainInterface.classList.add("opacity-50");
        });

        conn.on("data", (data) => {
          if (data.type === "file_received") {
            if (resolveUpload) resolveUpload();
          } else if (data.type === "sync_ack") {
            if (resolveSync) resolveSync();
          }
        });
      });

      // --- File Input ---
      document.getElementById("file-input").addEventListener("change", (e) => {
        handleNewFiles(Array.from(e.target.files));
        e.target.value = "";
      });

      function handleNewFiles(files) {
        if (files.length === 0) return;
        if (files.length > LIMIT_MAX_FILES)
          return alert(`Max ${LIMIT_MAX_FILES} files.`);

        const validFiles = files.filter(
          (f) => f.size / 1024 / 1024 <= LIMIT_MAX_SIZE_MB
        );
        if (validFiles.length === 0) return alert("Files too large.");

        fileQueue = validFiles;
        totalFiles = validFiles.length;
        processQueue();
      }

      // --- Library & DB ---
      async function openLibraryModal() {
        if (isProcessing) return;
        document.getElementById("lib-modal").classList.remove("hidden");

        try {
          await loadDatabase();
          renderPlaylistOptions();
          filterAndRenderLibrary("main");
        } catch (e) {
          console.error(e);
          document.getElementById(
            "lib-list"
          ).innerHTML = `<div class="text-red-500 text-center mt-10">DB Error (Same Device Only)</div>`;
        }
      }

      function closeLibraryModal() {
        document.getElementById("lib-modal").classList.add("hidden");
      }

      function loadDatabase() {
        return new Promise((resolve, reject) => {
          const req = indexedDB.open(DB_NAME, 8);
          req.onerror = () => reject("DB Error");
          req.onupgradeneeded = (e) => {
            e.target.transaction.abort();
            resolve();
          };

          req.onsuccess = (e) => {
            const db = e.target.result;
            if (
              !db.objectStoreNames.contains("library") ||
              !db.objectStoreNames.contains("playlists")
            ) {
              db.close();
              resolve();
              return;
            }
            const tx = db.transaction(["library", "playlists"], "readonly");

            const libReq = tx.objectStore("library").getAll();
            const plReq = tx.objectStore("playlists").getAll();

            libReq.onsuccess = () => {
              dbLibrary = libReq.result || [];
            };
            plReq.onsuccess = () => {
              const arr = plReq.result || [];
              dbPlaylists = {};
              arr.forEach((p) => (dbPlaylists[p.id] = p));
            };
            tx.oncomplete = () => {
              db.close();
              resolve();
            };
          };
        });
      }

      function renderPlaylistOptions() {
        const select = document.getElementById("playlist-select");
        select.innerHTML = '<option value="main">Main Library</option>';
        Object.keys(dbPlaylists).forEach((id) => {
          if (id === "main") return;
          const opt = document.createElement("option");
          opt.value = id;
          opt.textContent = dbPlaylists[id].name;
          select.appendChild(opt);
        });
        select.value = "main";
      }

      window.handlePlaylistChange = () => {
        const pid = document.getElementById("playlist-select").value;
        filterAndRenderLibrary(pid);
      };

      function filterAndRenderLibrary(playlistId) {
        if (playlistId === "main") {
          currentLibView = dbLibrary;
        } else {
          const pl = dbPlaylists[playlistId];
          currentLibView = pl
            ? pl.trackIds
                .map((tid) => dbLibrary.find((t) => t.id === tid))
                .filter((t) => t)
            : [];
        }
        renderList();
      }

      function renderList() {
        const listEl = document.getElementById("lib-list");
        listEl.innerHTML = "";

        if (currentLibView.length === 0) {
          listEl.innerHTML = `<div class="text-gray-500 text-center mt-10">Empty Playlist</div>`;
          return;
        }

        currentLibView.forEach((track, idx) => {
          const row = document.createElement("div");
          // Compact style mirroring app.html playlist items
          row.className =
            "flex justify-between cursor-pointer hover:bg-[#222] select-none text-green-500 group";
          row.onclick = (e) => {
            if (e.target.type !== "checkbox") {
              const cb = row.querySelector("input");
              cb.checked = !cb.checked;
              updateLibCount();
            }
          };

          row.innerHTML = `
                <div class="flex truncate w-full pointer-events-none items-center">
                    <input type="checkbox" class="mr-2 pointer-events-auto accent-green-500" value="${idx}">
                    <span class="w-4 text-right mr-1 flex-shrink-0 text-green-700 font-bold">${
                      idx + 1
                    }.</span>
                    <span class="truncate text-gray-300 group-hover:text-white">${
                      track.name
                    }</span>
                </div>
            `;
          listEl.appendChild(row);
        });
        updateLibCount();
      }

      function updateLibCount() {
        const checks = document.querySelectorAll("#lib-list input:checked");
        document.getElementById(
          "lib-count-disp"
        ).innerText = `SEL: ${checks.length}/${LIMIT_MAX_FILES}`;
      }

      window.confirmLibrarySelection = () => {
        const checks = document.querySelectorAll("#lib-list input:checked");
        if (checks.length === 0) return closeLibraryModal();

        const selectedFiles = [];
        checks.forEach((cb) => {
          const track = currentLibView[parseInt(cb.value)];
          if (track && track.blob) {
            try {
              selectedFiles.push(
                new File([track.blob], track.name, {
                  type: track.blob.type || "audio/mpeg",
                })
              );
            } catch (e) {
              track.blob.name = track.name;
              selectedFiles.push(track.blob);
            }
          }
        });

        closeLibraryModal();
        handleNewFiles(selectedFiles);
      };

      // --- Upload ---
      async function processQueue() {
        if (isProcessing) return;
        isProcessing = true;
        btnSelect.disabled = true;
        btnLibrary.disabled = true;
        progressArea.classList.remove("hidden");
        document.getElementById("queue-info").classList.remove("hidden");

        for (let i = 0; i < fileQueue.length; i++) {
          const file = fileQueue[i];
          document.getElementById("queue-count").innerText = `${
            i + 1
          }/${totalFiles}`;
          try {
            await sendFileRobust(file);
          } catch (err) {
            console.error(err);
            alert(`Failed: ${file.name}`);
          }
        }

        isProcessing = false;
        btnSelect.disabled = false;
        btnLibrary.disabled = false;

        document.getElementById("status-detail").innerText = "Completed!";
        document
          .getElementById("status-detail")
          .classList.add("text-green-500");

        setTimeout(() => {
          alert("Transfer Complete!");
          progressArea.classList.add("hidden");
          document.getElementById("queue-info").classList.add("hidden");
          document
            .getElementById("status-detail")
            .classList.remove("text-green-500");
          fileQueue = [];
        }, 500);
      }

      function sendFileRobust(file) {
        return new Promise((resolve, reject) => {
          if (!conn || !conn.open) return reject("No connection");

          const fileName = file.name || "unknown";
          document.getElementById("filename-disp").innerText = fileName;
          document.getElementById("status-detail").innerText = "Sending...";
          document.getElementById("progress-bar").style.width = "0%";
          document.getElementById("percent-disp").innerText = "0%";

          conn.send({
            type: "meta",
            name: fileName,
            size: file.size,
            mime: file.type || "audio/mpeg",
          });

          let offset = 0;
          let chunkCount = 0;
          const reader = new FileReader();

          reader.onload = async (event) => {
            try {
              const chunk = event.target.result;
              conn.send(chunk);
              offset += chunk.byteLength;
              chunkCount++;

              await new Promise((r) => setTimeout(r, 10));

              const p = Math.round((offset / file.size) * 100);
              document.getElementById("progress-bar").style.width = p + "%";
              document.getElementById("percent-disp").innerText = p + "%";

              if (chunkCount % SYNC_INTERVAL === 0) {
                conn.send({ type: "sync" });
                await new Promise((r) => (resolveSync = r));
              }

              if (offset < file.size) {
                readNextChunk();
              } else {
                document.getElementById("status-detail").innerText =
                  "Finalizing...";
                conn.send({ type: "end" });
                resolveUpload = resolve;
              }
            } catch (e) {
              reject(e);
            }
          };

          const readNextChunk = () => {
            const slice = file.slice(offset, offset + CHUNK_SIZE);
            reader.readAsArrayBuffer(slice);
          };

          readNextChunk();
        });
      }
    </script>
  </body>
</html>
