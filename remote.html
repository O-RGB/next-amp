<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Nextamp Remote</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@400;700&display=swap"
      rel="stylesheet"
    />

    <style>
      :root {
        --win-gray: #c0c0c0;
        --win-dark: #808080;
        --win-light: #ffffff;
        --win-black: #000000;
        --win-blue: #000080;
        --next-green: #00ff00;
      }

      body {
        background-color: #008080; /* Win98 Desktop Color */
        font-family: "Chakra Petch", sans-serif;
        overflow: hidden; /* Prevent body scroll */
      }

      /* Windows 98 Button Style */
      .win98-btn {
        background: var(--win-gray);
        color: black;
        border-top: 2px solid var(--win-light);
        border-left: 2px solid var(--win-light);
        border-right: 2px solid var(--win-black);
        border-bottom: 2px solid var(--win-black);
        box-shadow: 1px 1px 0px var(--win-dark);
        cursor: pointer;
        font-weight: bold;
        text-transform: uppercase;
        font-size: 12px;
        padding: 4px 8px;
        active: none;
      }
      .win98-btn:active,
      .win98-btn.pressed {
        border-top: 2px solid var(--win-black);
        border-left: 2px solid var(--win-black);
        border-right: 2px solid var(--win-light);
        border-bottom: 2px solid var(--win-light);
        transform: translate(1px, 1px);
        box-shadow: none;
      }
      .win98-btn:disabled {
        color: var(--win-dark);
        text-shadow: 1px 1px 0px var(--win-light);
        cursor: not-allowed;
      }

      /* Windows 98 Container Style */
      .win98-box {
        background: var(--win-gray);
        border-top: 2px solid var(--win-light);
        border-left: 2px solid var(--win-light);
        border-right: 2px solid var(--win-black);
        border-bottom: 2px solid var(--win-black);
        box-shadow: 1px 1px 0px var(--win-dark);
        padding: 2px;
      }

      /* Title Bar */
      .win98-title {
        background: linear-gradient(90deg, var(--win-blue), #1084d0);
        color: white;
        font-weight: bold;
        padding: 2px 4px;
        font-size: 14px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        letter-spacing: 1px;
      }

      /* Inset Panel (Sunken) */
      .win98-inset {
        border-top: 2px solid var(--win-dark);
        border-left: 2px solid var(--win-dark);
        border-right: 2px solid var(--win-light);
        border-bottom: 2px solid var(--win-light);
        background: black;
      }

      /* Custom Scrollbar */
      .custom-scroll::-webkit-scrollbar {
        width: 12px;
        background: var(--win-gray);
      }
      .custom-scroll::-webkit-scrollbar-thumb {
        background: var(--win-gray);
        border: 1px solid;
        border-color: var(--win-light) var(--win-black) var(--win-black)
          var(--win-light);
      }

      .playlist-item:hover {
        background-color: #222;
        color: white;
      }
    </style>
  </head>
  <body
    class="flex flex-col items-center justify-center min-h-screen p-2 select-none"
  >
    <div class="win98-box w-full max-w-sm flex flex-col relative z-10">
      <div class="win98-title mb-1">
        <span>NEXTAMP REMOTE</span>
        <div
          class="w-4 h-4 bg-[#c0c0c0] border border-white text-black text-[10px] flex items-center justify-center font-bold cursor-pointer"
        >
          X
        </div>
      </div>

      <div class="p-3 flex flex-col gap-4">
        <div
          class="win98-inset bg-black p-2 h-8 flex items-center justify-center"
        >
          <div
            id="connection-status"
            class="text-xs text-gray-400 font-mono animate-pulse"
          >
            Initializing...
          </div>
        </div>

        <div id="main-interface" class="flex flex-col gap-2 hidden">
          <input
            type="file"
            id="file-input"
            accept="audio/*,.mp3,.wav,.m4a,.ogg"
            multiple
            class="hidden"
          />

          <div class="grid grid-cols-2 gap-2">
            <button
              id="btn-select"
              onclick="document.getElementById('file-input').click()"
              class="win98-btn py-4 flex flex-col items-center justify-center gap-1"
            >
              <span class="text-xl">üìÅ</span>
              <span>BROWSE FILES</span>
            </button>
            <button
              id="btn-library"
              onclick="openLibraryModal()"
              class="win98-btn py-4 flex flex-col items-center justify-center gap-1"
            >
              <span class="text-xl">üíæ</span>
              <span>LIBRARY</span>
            </button>
          </div>

          <div id="queue-info" class="text-xs text-black mt-2 font-bold hidden">
            QUEUE: <span id="queue-count">0/0</span>
          </div>

          <div id="progress-area" class="hidden mt-1">
            <div class="flex justify-between text-[10px] mb-1 font-bold">
              <span id="filename-disp" class="truncate max-w-[150px]">...</span>
              <span id="percent-disp">0%</span>
            </div>
            <div class="border border-gray-600 h-4 bg-white relative">
              <div id="progress-bar" class="h-full bg-[#000080] w-0"></div>
              <div class="absolute inset-0 flex gap-[2px]"></div>
            </div>
            <div
              class="text-[10px] text-gray-600 mt-1 text-center"
              id="status-detail"
            >
              Waiting...
            </div>
          </div>
        </div>
      </div>

      <div
        class="p-1 text-[10px] text-gray-500 text-center border-t border-gray-400 mt-2"
      >
        NEXTAMP V.2.0 REMOTE
      </div>
    </div>

    <div
      id="lib-modal"
      class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 hidden"
    >
      <div class="win98-box w-[90%] max-w-sm h-[80vh] flex flex-col shadow-2xl">
        <div class="win98-title mb-1 cursor-grab">
          <span>SELECT TRACKS</span>
          <button
            onclick="closeLibraryModal()"
            class="w-4 h-4 bg-[#c0c0c0] border border-white text-black text-[10px] flex items-center justify-center font-bold"
          >
            X
          </button>
        </div>

        <div class="flex-1 flex flex-col p-2 gap-2 overflow-hidden">
          <div class="flex items-center gap-2 text-xs font-bold">
            <label>PLAYLIST:</label>
            <select
              id="playlist-select"
              onchange="handlePlaylistChange()"
              class="flex-1 bg-white border border-gray-600 text-xs p-1 outline-none"
            >
              <option value="main">Main Library (All)</option>
            </select>
          </div>

          <div
            class="flex-1 win98-inset overflow-y-auto custom-scroll p-1 relative bg-black"
          >
            <div id="lib-list" class="space-y-[2px]">
              <div class="text-center text-[#00ff00] py-8 text-xs font-mono">
                Loading Database...
              </div>
            </div>
          </div>

          <div class="flex justify-between items-center px-1">
            <span id="lib-count-disp" class="text-[10px] font-bold"
              >SELECTED: 0/10</span
            >
          </div>

          <div class="flex gap-2 pt-2 border-t border-gray-400">
            <button onclick="closeLibraryModal()" class="win98-btn flex-1 py-2">
              CANCEL
            </button>
            <button
              onclick="confirmLibrarySelection()"
              class="win98-btn flex-1 py-2 font-bold text-blue-900"
            >
              SEND OK
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      // CONFIG
      const CHUNK_SIZE = 16 * 1024;
      const SYNC_INTERVAL = 20;
      const LIMIT_MAX_FILES = 10;
      const LIMIT_MAX_SIZE_MB = 100;
      const DB_NAME = "NextampUltimateDB";

      const params = new URLSearchParams(window.location.search);
      const hostId = params.get("host");

      const statusEl = document.getElementById("connection-status");
      const mainInterface = document.getElementById("main-interface");
      const btnSelect = document.getElementById("btn-select");
      const btnLibrary = document.getElementById("btn-library");
      const progressArea = document.getElementById("progress-area");

      let peer = null,
        conn = null;
      let fileQueue = [],
        totalFiles = 0;
      let isProcessing = false;

      // Library Data
      let dbLibrary = []; // All tracks
      let dbPlaylists = {}; // Playlist definitions
      let currentLibView = []; // Filtered list

      // Sync
      let resolveUpload = null;
      let resolveSync = null;

      if (!hostId) {
        statusEl.innerText = "ERROR: NO HOST ID";
        statusEl.className = "text-xs text-red-600 font-bold bg-white px-2";
        throw new Error("No Host ID");
      }

      peer = new Peer();

      peer.on("open", (id) => {
        statusEl.innerText = "Connecting to Host...";
        conn = peer.connect(hostId, { reliable: true });

        conn.on("open", () => {
          statusEl.innerText = "ONLINE: READY";
          statusEl.className =
            "text-xs text-[#008000] font-bold bg-white px-2 border border-gray-400";
          mainInterface.classList.remove("hidden");
        });

        conn.on("close", () => {
          statusEl.innerText = "OFFLINE";
          statusEl.className =
            "text-xs text-red-600 font-bold bg-white px-2 border border-red-600";
          btnSelect.disabled = true;
          btnLibrary.disabled = true;
          mainInterface.classList.add("opacity-50");
        });

        conn.on("data", (data) => {
          if (data.type === "file_received") {
            if (resolveUpload) resolveUpload();
          } else if (data.type === "sync_ack") {
            if (resolveSync) resolveSync();
          }
        });
      });

      // --- File Input Handling ---
      document.getElementById("file-input").addEventListener("change", (e) => {
        const files = Array.from(e.target.files);
        handleNewFiles(files);
        e.target.value = "";
      });

      function handleNewFiles(files) {
        if (files.length === 0) return;
        if (files.length > LIMIT_MAX_FILES)
          return alert(`Max ${LIMIT_MAX_FILES} files.`);

        const validFiles = files.filter(
          (f) => f.size / 1024 / 1024 <= LIMIT_MAX_SIZE_MB
        );
        if (validFiles.length === 0) return alert("Files too large.");

        fileQueue = validFiles;
        totalFiles = validFiles.length;
        processQueue();
      }

      // --- Library & DB Handling ---

      async function openLibraryModal() {
        if (isProcessing) return;
        document.getElementById("lib-modal").classList.remove("hidden");

        try {
          await loadDatabase();
          renderPlaylistOptions();
          filterAndRenderLibrary("main"); // Default to main
        } catch (e) {
          console.error(e);
          document.getElementById(
            "lib-list"
          ).innerHTML = `<div class="text-red-500 text-center text-xs mt-4">DB Error: ${e}</div>`;
        }
      }

      function closeLibraryModal() {
        document.getElementById("lib-modal").classList.add("hidden");
        // Clear checkboxes visually? No need, logic handles it next open or we can reset
      }

      function loadDatabase() {
        return new Promise((resolve, reject) => {
          const req = indexedDB.open(DB_NAME, 8);
          req.onerror = () => reject("Failed to open DB");
          req.onupgradeneeded = (e) => {
            e.target.transaction.abort();
            resolve();
          }; // No DB yet

          req.onsuccess = (e) => {
            const db = e.target.result;
            if (
              !db.objectStoreNames.contains("library") ||
              !db.objectStoreNames.contains("playlists")
            ) {
              db.close();
              resolve(); // Empty
              return;
            }

            // Load Library
            const tx = db.transaction(["library", "playlists"], "readonly");

            const libReq = tx.objectStore("library").getAll();
            const plReq = tx.objectStore("playlists").getAll();

            libReq.onsuccess = () => {
              dbLibrary = libReq.result || [];
            };
            plReq.onsuccess = () => {
              const arr = plReq.result || [];
              dbPlaylists = {};
              arr.forEach((p) => (dbPlaylists[p.id] = p));
            };

            tx.oncomplete = () => {
              db.close();
              resolve();
            };
          };
        });
      }

      function renderPlaylistOptions() {
        const select = document.getElementById("playlist-select");
        select.innerHTML = '<option value="main">Main Library</option>';
        Object.keys(dbPlaylists).forEach((id) => {
          if (id === "main") return; // skip if stored
          const opt = document.createElement("option");
          opt.value = id;
          opt.textContent = dbPlaylists[id].name;
          select.appendChild(opt);
        });
        select.value = "main";
      }

      window.handlePlaylistChange = () => {
        const pid = document.getElementById("playlist-select").value;
        filterAndRenderLibrary(pid);
      };

      function filterAndRenderLibrary(playlistId) {
        if (playlistId === "main") {
          currentLibView = dbLibrary;
        } else {
          const pl = dbPlaylists[playlistId];
          if (!pl) {
            currentLibView = [];
          } else {
            // Map IDs to track objects
            currentLibView = pl.trackIds
              .map((tid) => dbLibrary.find((t) => t.id === tid))
              .filter((t) => t);
          }
        }
        renderList();
      }

      function renderList() {
        const listEl = document.getElementById("lib-list");
        listEl.innerHTML = "";

        if (currentLibView.length === 0) {
          listEl.innerHTML = `<div class="text-gray-500 text-center text-[10px] mt-4 font-mono">No tracks found.</div>`;
          return;
        }

        currentLibView.forEach((track, idx) => {
          // Style matching app.html: Green text on black, monospace font
          const row = document.createElement("div");
          row.className =
            "flex items-center gap-2 p-1 cursor-pointer hover:bg-[#222] group";
          row.onclick = (e) => {
            if (e.target.type !== "checkbox") {
              const cb = row.querySelector("input");
              cb.checked = !cb.checked;
              updateLibCount();
            }
          };

          row.innerHTML = `
                <input type="checkbox" class="cursor-pointer" value="${idx}">
                <div class="flex-1 min-w-0 font-mono text-xs text-[#00ff00] truncate">
                    <span class="text-[#008800] mr-1">${idx + 1}.</span>${
            track.name
          }
                </div>
            `;
          listEl.appendChild(row);
        });
        updateLibCount();
      }

      function updateLibCount() {
        const checks = document.querySelectorAll("#lib-list input:checked");
        document.getElementById(
          "lib-count-disp"
        ).innerText = `SELECTED: ${checks.length}/${LIMIT_MAX_FILES}`;
      }

      window.confirmLibrarySelection = () => {
        const checks = document.querySelectorAll("#lib-list input:checked");
        if (checks.length === 0) return closeLibraryModal();
        if (checks.length > LIMIT_MAX_FILES)
          return alert("Too many files selected!");

        const selectedFiles = [];
        checks.forEach((cb) => {
          const idx = parseInt(cb.value);
          const track = currentLibView[idx];
          if (track && track.blob) {
            // Construct file
            try {
              const f = new File([track.blob], track.name, {
                type: track.blob.type || "audio/mpeg",
              });
              selectedFiles.push(f);
            } catch (e) {
              track.blob.name = track.name;
              selectedFiles.push(track.blob);
            }
          }
        });

        closeLibraryModal();
        handleNewFiles(selectedFiles);
      };

      // --- Upload Process ---
      async function processQueue() {
        if (isProcessing) return;
        isProcessing = true;
        btnSelect.disabled = true;
        btnLibrary.disabled = true;
        progressArea.classList.remove("hidden");
        document.getElementById("queue-info").classList.remove("hidden");

        for (let i = 0; i < fileQueue.length; i++) {
          const file = fileQueue[i];
          document.getElementById("queue-count").innerText = `${
            i + 1
          }/${totalFiles}`;
          try {
            await sendFileRobust(file);
          } catch (err) {
            console.error(err);
            alert(`Error: ${file.name}`);
          }
        }

        isProcessing = false;
        btnSelect.disabled = false;
        btnLibrary.disabled = false;

        document.getElementById("status-detail").innerText = "Success!";
        document
          .getElementById("status-detail")
          .classList.add("text-[#008000]", "font-bold");

        setTimeout(() => {
          alert("All Files Transferred!");
          progressArea.classList.add("hidden");
          document.getElementById("queue-info").classList.add("hidden");
          document
            .getElementById("status-detail")
            .classList.remove("text-[#008000]", "font-bold");
          fileQueue = [];
        }, 500);
      }

      function sendFileRobust(file) {
        return new Promise((resolve, reject) => {
          if (!conn || !conn.open) return reject("No connection");

          const fileName = file.name || "audio_file";
          document.getElementById("filename-disp").innerText = fileName;
          document.getElementById("status-detail").innerText = "Sending...";
          document.getElementById("progress-bar").style.width = "0%";
          document.getElementById("percent-disp").innerText = "0%";

          conn.send({
            type: "meta",
            name: fileName,
            size: file.size,
            mime: file.type || "audio/mpeg",
          });

          let offset = 0;
          let chunkCount = 0;
          const reader = new FileReader();

          reader.onload = async (event) => {
            try {
              const chunk = event.target.result;
              conn.send(chunk);
              offset += chunk.byteLength;
              chunkCount++;

              await new Promise((r) => setTimeout(r, 10)); // throttle

              const p = Math.round((offset / file.size) * 100);
              document.getElementById("progress-bar").style.width = p + "%";
              document.getElementById("percent-disp").innerText = p + "%";

              if (chunkCount % SYNC_INTERVAL === 0) {
                conn.send({ type: "sync" });
                await new Promise((r) => (resolveSync = r));
              }

              if (offset < file.size) {
                readNextChunk();
              } else {
                document.getElementById("status-detail").innerText =
                  "Finishing...";
                conn.send({ type: "end" });
                resolveUpload = resolve;
              }
            } catch (e) {
              reject(e);
            }
          };

          const readNextChunk = () => {
            const slice = file.slice(offset, offset + CHUNK_SIZE);
            reader.readAsArrayBuffer(slice);
          };

          readNextChunk();
        });
      }
    </script>
  </body>
</html>
