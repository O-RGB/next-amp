<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Nextamp Remote</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <style>
      body {
        background-color: #050505;
        color: #e5e5e5;
        font-family: "Chakra Petch", sans-serif;
        overflow: hidden;
      }

      /* Neon Glow Effects */
      .glow-text {
        text-shadow: 0 0 10px rgba(0, 255, 0, 0.5);
      }
      .glow-border {
        box-shadow: 0 0 15px rgba(0, 255, 0, 0.1);
      }
      .glow-border:hover {
        box-shadow: 0 0 20px rgba(0, 255, 0, 0.3);
        border-color: #00ff00;
      }

      /* Custom Scrollbar */
      .custom-scroll::-webkit-scrollbar {
        width: 6px;
      }
      .custom-scroll::-webkit-scrollbar-track {
        background: #111;
      }
      .custom-scroll::-webkit-scrollbar-thumb {
        background: #333;
        border-radius: 3px;
      }
      .custom-scroll::-webkit-scrollbar-thumb:hover {
        background: #00ff00;
      }

      /* Animations */
      @keyframes pulse-green {
        0%,
        100% {
          opacity: 0.1;
        }
        50% {
          opacity: 0.2;
        }
      }
      .bg-pulse {
        animation: pulse-green 4s infinite;
      }
    </style>
  </head>
  <body
    class="flex flex-col items-center justify-center min-h-screen p-4 relative"
  >
    <div
      class="absolute top-0 left-1/2 -translate-x-1/2 w-[600px] h-[600px] bg-green-500/10 rounded-full blur-[100px] pointer-events-none bg-pulse"
    ></div>

    <div
      class="w-full max-w-md bg-black/40 backdrop-blur-xl border border-white/10 rounded-2xl p-6 shadow-2xl relative z-10 flex flex-col gap-6"
    >
      <div class="text-center space-y-1">
        <h1 class="text-3xl font-bold tracking-widest text-white glow-text">
          NEXTAMP <span class="text-[#00ff00]">REMOTE</span>
        </h1>
        <div class="flex items-center justify-center gap-2">
          <div id="status-dot" class="w-2 h-2 rounded-full bg-gray-500"></div>
          <div
            id="connection-status"
            class="text-xs text-gray-400 font-mono tracking-wider"
          >
            INITIALIZING...
          </div>
        </div>
      </div>

      <div
        id="main-interface"
        class="flex flex-col gap-4 hidden transition-opacity duration-300"
      >
        <input
          type="file"
          id="file-input"
          accept="audio/*,.mp3,.wav,.m4a,.ogg"
          multiple
          class="hidden"
        />

        <div class="grid grid-cols-1 gap-4">
          <button
            id="btn-select"
            onclick="document.getElementById('file-input').click()"
            class="group relative overflow-hidden rounded-xl border border-white/20 bg-white/5 p-6 hover:bg-green-900/20 transition-all glow-border"
          >
            <div class="flex flex-col items-center gap-2">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="w-8 h-8 text-green-400 group-hover:scale-110 transition-transform"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"
                />
              </svg>
              <span class="font-bold text-lg text-white">SELECT FILES</span>
              <span class="text-[10px] text-gray-400 group-hover:text-green-300"
                >FROM DEVICE STORAGE</span
              >
            </div>
          </button>

          <button
            id="btn-library"
            onclick="openLibraryModal()"
            class="group relative overflow-hidden rounded-xl border border-white/20 bg-white/5 p-4 hover:bg-green-900/20 transition-all glow-border"
          >
            <div class="flex flex-col items-center gap-1">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="w-6 h-6 text-green-400 group-hover:scale-110 transition-transform"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4"
                />
              </svg>
              <span class="font-bold text-white">SELECT FROM LIBRARY</span>
              <span class="text-[10px] text-gray-400 group-hover:text-green-300"
                >NEXTAMP DATABASE</span
              >
            </div>
          </button>
        </div>

        <div
          id="progress-area"
          class="hidden bg-black/50 border border-green-500/30 rounded-lg p-4 space-y-2 mt-2"
        >
          <div class="flex justify-between text-xs font-mono text-green-400">
            <span id="filename-disp" class="truncate max-w-[200px]"
              >Uploading...</span
            >
            <span id="percent-disp">0%</span>
          </div>
          <div class="w-full h-1.5 bg-gray-800 rounded-full overflow-hidden">
            <div
              id="progress-bar"
              class="h-full bg-green-500 shadow-[0_0_10px_#00ff00] w-0 transition-all duration-100"
            ></div>
          </div>
          <div
            id="queue-info"
            class="text-[10px] text-gray-500 text-center flex justify-between"
          >
            <span id="status-detail">Waiting...</span>
            <span id="queue-count">0/0</span>
          </div>
        </div>
      </div>

      <div class="text-center">
        <p class="text-[10px] text-gray-600 font-mono">
          SECURE P2P CONNECTION â€¢ V2.1
        </p>
      </div>
    </div>

    <div
      id="lib-modal"
      class="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm hidden transition-opacity"
    >
      <div
        class="w-full max-w-sm h-[80vh] bg-[#0a0a0a] border border-green-500/30 rounded-xl shadow-[0_0_30px_rgba(0,255,0,0.1)] flex flex-col overflow-hidden m-4"
      >
        <div
          class="p-4 border-b border-white/10 bg-white/5 flex justify-between items-center"
        >
          <h2
            class="text-white font-bold tracking-wider flex items-center gap-2"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="w-5 h-5 text-green-500"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"
              />
            </svg>
            LIBRARY
          </h2>
          <button
            onclick="closeLibraryModal()"
            class="text-gray-500 hover:text-white transition"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="w-6 h-6"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              />
            </svg>
          </button>
        </div>

        <div class="p-3 border-b border-white/5 bg-black/20">
          <select
            id="playlist-select"
            onchange="handlePlaylistChange()"
            class="w-full bg-[#111] text-gray-300 text-sm p-2 rounded border border-white/10 focus:border-green-500 outline-none"
          >
            <option value="main">Main Library (All Tracks)</option>
          </select>
        </div>

        <div
          id="lib-list"
          class="flex-1 overflow-y-auto p-2 space-y-1 custom-scroll"
        >
          <div
            class="text-center text-gray-600 py-10 text-xs font-mono animate-pulse"
          >
            Loading Database...
          </div>
        </div>

        <div class="p-4 border-t border-white/10 bg-white/5">
          <div class="flex justify-between items-center mb-3">
            <span id="lib-count-disp" class="text-xs text-green-400 font-mono"
              >SELECTED: 0/10</span
            >
          </div>
          <button
            onclick="confirmLibrarySelection()"
            class="w-full py-3 rounded-lg bg-green-600 hover:bg-green-500 text-black font-bold tracking-wide transition shadow-[0_0_15px_rgba(0,255,0,0.3)]"
          >
            SEND SELECTED TRACKS
          </button>
        </div>
      </div>
    </div>

    <script>
      // CONFIG
      const CHUNK_SIZE = 16 * 1024;
      const SYNC_INTERVAL = 20;
      const LIMIT_MAX_FILES = 10;
      const LIMIT_MAX_SIZE_MB = 100;
      const DB_NAME = "NextampUltimateDB";

      const params = new URLSearchParams(window.location.search);
      const hostId = params.get("host");

      const statusEl = document.getElementById("connection-status");
      const statusDot = document.getElementById("status-dot");
      const mainInterface = document.getElementById("main-interface");
      const btnSelect = document.getElementById("btn-select");
      const btnLibrary = document.getElementById("btn-library");
      const progressArea = document.getElementById("progress-area");

      let peer = null,
        conn = null;
      let fileQueue = [],
        totalFiles = 0;
      let isProcessing = false;

      // Library Data
      let dbLibrary = [];
      let dbPlaylists = {};
      let currentLibView = [];

      // Sync
      let resolveUpload = null;
      let resolveSync = null;

      function updateStatus(msg, colorClass, dotColor) {
        statusEl.innerText = msg;
        statusEl.className = `text-xs font-mono tracking-wider ${colorClass}`;
        statusDot.className = `w-2 h-2 rounded-full ${dotColor} shadow-[0_0_5px_currentColor]`;
      }

      if (!hostId) {
        updateStatus("ERROR: INVALID LINK", "text-red-500", "bg-red-500");
        throw new Error("No Host ID");
      }

      peer = new Peer();

      peer.on("open", (id) => {
        updateStatus(
          "CONNECTING...",
          "text-yellow-500",
          "bg-yellow-500 animate-pulse"
        );
        conn = peer.connect(hostId, { reliable: true });

        conn.on("open", () => {
          updateStatus("CONNECTED / READY", "text-green-400", "bg-green-500");
          mainInterface.classList.remove("hidden");
        });

        conn.on("close", () => {
          updateStatus("DISCONNECTED", "text-red-500", "bg-red-500");
          btnSelect.disabled = true;
          btnLibrary.disabled = true;
          mainInterface.classList.add("opacity-50");
        });

        conn.on("data", (data) => {
          if (data.type === "file_received") {
            if (resolveUpload) resolveUpload();
          } else if (data.type === "sync_ack") {
            if (resolveSync) resolveSync();
          }
        });
      });

      // --- File Input ---
      document.getElementById("file-input").addEventListener("change", (e) => {
        handleNewFiles(Array.from(e.target.files));
        e.target.value = "";
      });

      function handleNewFiles(files) {
        if (files.length === 0) return;
        if (files.length > LIMIT_MAX_FILES)
          return alert(`Max ${LIMIT_MAX_FILES} files.`);

        const validFiles = files.filter(
          (f) => f.size / 1024 / 1024 <= LIMIT_MAX_SIZE_MB
        );
        if (validFiles.length === 0) return alert("Files too large.");

        fileQueue = validFiles;
        totalFiles = validFiles.length;
        processQueue();
      }

      // --- Library & DB ---
      async function openLibraryModal() {
        if (isProcessing) return;
        document.getElementById("lib-modal").classList.remove("hidden");

        try {
          await loadDatabase();
          renderPlaylistOptions();
          filterAndRenderLibrary("main");
        } catch (e) {
          console.error(e);
          document.getElementById(
            "lib-list"
          ).innerHTML = `<div class="text-red-500 text-center text-xs mt-10">Cannot access Nextamp Database.<br>Are you on the same device?</div>`;
        }
      }

      function closeLibraryModal() {
        document.getElementById("lib-modal").classList.add("hidden");
      }

      function loadDatabase() {
        return new Promise((resolve, reject) => {
          const req = indexedDB.open(DB_NAME, 8);
          req.onerror = () => reject("DB Error");
          req.onupgradeneeded = (e) => {
            e.target.transaction.abort();
            resolve();
          };

          req.onsuccess = (e) => {
            const db = e.target.result;
            if (
              !db.objectStoreNames.contains("library") ||
              !db.objectStoreNames.contains("playlists")
            ) {
              db.close();
              resolve();
              return;
            }
            const tx = db.transaction(["library", "playlists"], "readonly");

            const libReq = tx.objectStore("library").getAll();
            const plReq = tx.objectStore("playlists").getAll();

            libReq.onsuccess = () => {
              dbLibrary = libReq.result || [];
            };
            plReq.onsuccess = () => {
              const arr = plReq.result || [];
              dbPlaylists = {};
              arr.forEach((p) => (dbPlaylists[p.id] = p));
            };
            tx.oncomplete = () => {
              db.close();
              resolve();
            };
          };
        });
      }

      function renderPlaylistOptions() {
        const select = document.getElementById("playlist-select");
        select.innerHTML =
          '<option value="main">Main Library (All Tracks)</option>';
        Object.keys(dbPlaylists).forEach((id) => {
          if (id === "main") return;
          const opt = document.createElement("option");
          opt.value = id;
          opt.textContent = dbPlaylists[id].name;
          select.appendChild(opt);
        });
        select.value = "main";
      }

      window.handlePlaylistChange = () => {
        const pid = document.getElementById("playlist-select").value;
        filterAndRenderLibrary(pid);
      };

      function filterAndRenderLibrary(playlistId) {
        if (playlistId === "main") {
          currentLibView = dbLibrary;
        } else {
          const pl = dbPlaylists[playlistId];
          currentLibView = pl
            ? pl.trackIds
                .map((tid) => dbLibrary.find((t) => t.id === tid))
                .filter((t) => t)
            : [];
        }
        renderList();
      }

      function renderList() {
        const listEl = document.getElementById("lib-list");
        listEl.innerHTML = "";

        if (currentLibView.length === 0) {
          listEl.innerHTML = `<div class="text-gray-500 text-center text-xs mt-10">No tracks found in this playlist.</div>`;
          return;
        }

        currentLibView.forEach((track, idx) => {
          const row = document.createElement("div");
          row.className =
            "flex items-center gap-3 p-3 rounded hover:bg-white/5 cursor-pointer group transition-colors border border-transparent hover:border-white/10";
          row.onclick = (e) => {
            if (e.target.type !== "checkbox") {
              const cb = row.querySelector("input");
              cb.checked = !cb.checked;
              updateLibCount();
            }
          };

          row.innerHTML = `
                <input type="checkbox" class="accent-green-500 w-4 h-4 cursor-pointer" value="${idx}">
                <div class="flex-1 min-w-0">
                    <div class="text-sm text-gray-200 group-hover:text-green-400 font-medium truncate">${
                      track.name
                    }</div>
                    <div class="text-[10px] text-gray-500 font-mono">${(
                      track.blob.size /
                      1024 /
                      1024
                    ).toFixed(1)} MB</div>
                </div>
            `;
          listEl.appendChild(row);
        });
        updateLibCount();
      }

      function updateLibCount() {
        const checks = document.querySelectorAll("#lib-list input:checked");
        document.getElementById(
          "lib-count-disp"
        ).innerText = `SELECTED: ${checks.length}/${LIMIT_MAX_FILES}`;
      }

      window.confirmLibrarySelection = () => {
        const checks = document.querySelectorAll("#lib-list input:checked");
        if (checks.length === 0) return closeLibraryModal();

        const selectedFiles = [];
        checks.forEach((cb) => {
          const track = currentLibView[parseInt(cb.value)];
          if (track && track.blob) {
            try {
              selectedFiles.push(
                new File([track.blob], track.name, {
                  type: track.blob.type || "audio/mpeg",
                })
              );
            } catch (e) {
              track.blob.name = track.name;
              selectedFiles.push(track.blob);
            }
          }
        });

        closeLibraryModal();
        handleNewFiles(selectedFiles);
      };

      // --- Upload ---
      async function processQueue() {
        if (isProcessing) return;
        isProcessing = true;
        btnSelect.disabled = true;
        btnLibrary.disabled = true;
        progressArea.classList.remove("hidden");
        document.getElementById("queue-info").classList.remove("hidden");

        // Disable buttons visual
        btnSelect.classList.add("opacity-50", "cursor-not-allowed");
        btnLibrary.classList.add("opacity-50", "cursor-not-allowed");

        for (let i = 0; i < fileQueue.length; i++) {
          const file = fileQueue[i];
          document.getElementById("queue-count").innerText = `${
            i + 1
          }/${totalFiles}`;
          try {
            await sendFileRobust(file);
          } catch (err) {
            console.error(err);
            alert(`Failed: ${file.name}`);
          }
        }

        isProcessing = false;
        btnSelect.disabled = false;
        btnLibrary.disabled = false;
        btnSelect.classList.remove("opacity-50", "cursor-not-allowed");
        btnLibrary.classList.remove("opacity-50", "cursor-not-allowed");

        document.getElementById("status-detail").innerText = "Completed";
        document
          .getElementById("status-detail")
          .classList.add("text-green-400");

        setTimeout(() => {
          alert("Transfer Complete!");
          progressArea.classList.add("hidden");
          document.getElementById("queue-info").classList.add("hidden");
          document
            .getElementById("status-detail")
            .classList.remove("text-green-400");
          fileQueue = [];
        }, 500);
      }

      function sendFileRobust(file) {
        return new Promise((resolve, reject) => {
          if (!conn || !conn.open) return reject("No connection");

          const fileName = file.name || "unknown";
          document.getElementById("filename-disp").innerText = fileName;
          document.getElementById("status-detail").innerText = "Sending...";
          document.getElementById("progress-bar").style.width = "0%";
          document.getElementById("percent-disp").innerText = "0%";

          conn.send({
            type: "meta",
            name: fileName,
            size: file.size,
            mime: file.type || "audio/mpeg",
          });

          let offset = 0;
          let chunkCount = 0;
          const reader = new FileReader();

          reader.onload = async (event) => {
            try {
              const chunk = event.target.result;
              conn.send(chunk);
              offset += chunk.byteLength;
              chunkCount++;

              await new Promise((r) => setTimeout(r, 10));

              const p = Math.round((offset / file.size) * 100);
              document.getElementById("progress-bar").style.width = p + "%";
              document.getElementById("percent-disp").innerText = p + "%";

              if (chunkCount % SYNC_INTERVAL === 0) {
                conn.send({ type: "sync" });
                await new Promise((r) => (resolveSync = r));
              }

              if (offset < file.size) {
                readNextChunk();
              } else {
                document.getElementById("status-detail").innerText =
                  "Finalizing...";
                conn.send({ type: "end" });
                resolveUpload = resolve;
              }
            } catch (e) {
              reject(e);
            }
          };

          const readNextChunk = () => {
            const slice = file.slice(offset, offset + CHUNK_SIZE);
            reader.readAsArrayBuffer(slice);
          };

          readNextChunk();
        });
      }
    </script>
  </body>
</html>
