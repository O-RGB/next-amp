<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"
    />
    <title>Nextamp Player</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@400;500;600&family=Inter:wght@400;600&display=swap"
      rel="stylesheet"
    />

    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              "win-base": "#1a1a1a",
              "win-gray": "#292929",
              "btn-face": "#c0c0c0",
              "win-green": "#00ff00",
              "win-gold": "#ffcc00",
            },
            fontFamily: {
              pixel: ['"Chakra Petch"', "sans-serif"],
              ui: ['"Inter"', "sans-serif"],
            },
            cursor: { "win-pointer": "default" },
          },
        },
      };
    </script>
    <style>
      :root {
        --theme-window: #000080;
        --theme-text: #00ff00;
        --theme-text-sec: #ffcc00;
        --theme-highlight: #000080;

        /* EQ GRADIENT */
        --eq-col-1: #00ff00;
        --eq-col-2: #ffff00;
        --eq-col-3: #ff0000;
      }

      html,
      body {
        /* iOS Safari Fixes */
        height: 100dvh;
        width: 100vw;
        position: fixed;
        inset: 0;
        overflow: hidden;
        overscroll-behavior: none;
        touch-action: none;
        user-select: none;
        -webkit-user-select: none;
        color: #e5e5e5;

        /* --- NEW BACKGROUND: Deep Tech Green Gradient --- */
        /* Dark center with green tint, fading to absolute black edges */
        background: radial-gradient(circle at center, #003504 0%, #020617 80%);

        /* Safe Area padding */
        padding-top: max(8px, env(safe-area-inset-top));
        padding-bottom: max(4px, env(safe-area-inset-bottom));
        padding-left: max(4px, env(safe-area-inset-left));
        padding-right: max(4px, env(safe-area-inset-right));
      }

      /* --- CLASSIC BUTTONS --- */
      .win-btn {
        background-color: #c0c0c0;
        color: black;
        border-top: 2px solid #fff;
        border-left: 2px solid #fff;
        border-right: 2px solid #000;
        border-bottom: 2px solid #000;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 11px;
        font-weight: bold;
        z-index: 30;
      }
      .win-btn:active,
      .win-btn.pressed {
        border-top: 2px solid #000;
        border-left: 2px solid #000;
        border-right: 2px solid #fff;
        border-bottom: 2px solid #fff;
        background-color: #a0a0a0;
      }

      /* Outer Glow - Matching the Green-400 */
      .sci-fi-container-glow {
        box-shadow: 0 0 25px rgba(0, 226, 83, 0.15),
          0 0 50px rgba(0, 227, 83, 0.05);
        border-radius: 2px;
      }

      /* Classic Text Button */
      .retro-txt-btn {
        background-color: #111;
        border: 1px solid #444;
        color: #888;
        font-family: "Chakra Petch", sans-serif;
        font-size: 9px;
        text-align: center;
        cursor: pointer;
        line-height: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        padding-top: 2px;
        border-radius: 2px;
        box-shadow: inset 1px 1px 0 #000;
      }
      .retro-txt-btn.active {
        color: var(--theme-text) !important;
        border-color: var(--theme-text);
        box-shadow: 0 0 4px var(--theme-text);
        text-shadow: 0 0 2px var(--theme-text);
      }
      .retro-txt-btn.active-gold {
        color: var(--theme-text-sec) !important;
        border-color: var(--theme-text-sec);
        box-shadow: 0 0 4px var(--theme-text-sec);
        text-shadow: 0 0 2px var(--theme-text-sec);
      }

      /* Theme & EQ colors */
      .theme-bar {
        background-color: var(--theme-window);
        color: white;
      }
      .theme-text-main {
        color: var(--theme-text);
      }
      .theme-text-sec {
        color: var(--theme-text-sec);
      }
      .theme-highlight-bg {
        background-color: var(--theme-highlight); /* Transparent Green-400 */
        color: #fff;
        outline: 1px solid var(--theme-window);
      }

      .eq-bar-bg {
        background: linear-gradient(to top, #333 0%, #333 100%);
        width: 4px;
        height: 100%;
        margin: 0 auto;
        border-left: 1px solid #111;
        border-right: 1px solid #555;
      }
      .eq-bar-active {
        background: linear-gradient(
          to top,
          var(--eq-col-1) 0%,
          var(--eq-col-2) 70%,
          var(--eq-col-3) 100%
        );
        box-shadow: 0 0 4px var(--eq-col-1);
      }
      .text-shadow {
        text-shadow: 0px 0px 3px rgba(0, 221, 81, 0.6);
      }

      /* Sliders */
      input[type="range"] {
        -webkit-appearance: none;
        background: transparent;
      }
      input[type="range"]:focus {
        outline: none;
      }
      input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        height: 10px;
        width: 20px;
        background: #c0c0c0;
        border: 1px solid #000;
        box-shadow: inset 1px 1px #fff;
        cursor: pointer;
        position: relative;
        z-index: 20;
        margin-top: -3px;
      }
      input[type="range"]::-webkit-slider-runnable-track {
        width: 100%;
        height: 4px;
        background: #000;
        border-bottom: 1px solid #333;
      }
      input[type="range"].vertical {
        writing-mode: bt-lr;
        -webkit-appearance: slider-vertical;
        width: 25px;
        margin: 0;
        padding: 0;
        opacity: 0;
        position: absolute;
        top: 0;
        left: 0;
        height: 100%;
        z-index: 20;
        cursor: pointer;
      }
      .eq-thumb {
        height: 10px;
        width: 17px;
        background: #c0c0c0;
        border: 1px solid #000;
        border-top: 1px solid #fff;
        border-left: 1px solid #fff;
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
        pointer-events: none;
        z-index: 10;
        margin-top: -3px;
      }

      .dragging {
        opacity: 0.5;
        background: #444;
      }
      .drag-over {
        border-top: 2px solid var(--theme-text);
      }
      .custom-scroll::-webkit-scrollbar {
        width: 10px;
        background: #292929;
      }
      .custom-scroll::-webkit-scrollbar-thumb {
        background: #c0c0c0;
        border: 1px solid #fff;
        border-right: 1px solid #000;
        border-bottom: 1px solid #000;
      }

      #slider-tooltip {
        position: absolute;
        background: #ffff00;
        color: #000;
        border: 1px solid #000;
        padding: 2px 4px;
        font-family: "Chakra Petch", sans-serif;
        font-size: 10px;
        font-weight: bold;
        pointer-events: none;
        z-index: 10000;
        display: none;
        white-space: nowrap;
        box-shadow: 2px 2px 0px rgba(0, 0, 0, 0.5);
      }
    </style>
  </head>
  <body class="flex flex-col items-center w-full h-full">
    <div id="slider-tooltip">0</div>

    <audio
      id="audio-startup"
      src="/assets/sounds/startup.mp3"
      preload="auto"
    ></audio>
    <audio
      id="audio-loop"
      src="/assets/sounds/allow-sound.mp3"
      loop
      preload="auto"
    ></audio>
    <button
      id="btn-install-pwa"
      class="hidden fixed top-2 right-2 z-50 bg-win-green text-black px-3 py-1 text-xs font-bold border-2 border-white shadow-lg animate-bounce"
    >
      INSTALL APP
    </button>

    <div
      class="w-full h-full max-w-xl xl:max-w-sm mx-auto overflow-hidden flex flex-col pb-1 sci-fi-container-glow relative z-10"
    >
      <div
        class="flex-none flex flex-col gap-2 origin-center transition-transform duration-300"
      >
        <div
          class="bg-[#292929] border-t-2 border-l-2 border-gray-500 border-r-2 border-b-2 border-black relative z-20 shadow-lg"
        >
          <div
            class="theme-bar h-5 flex justify-between items-center px-1 text-[10px] font-bold cursor-grab"
          >
            <div class="flex items-center gap-1">
              <i class="ph-bold ph-music-note"></i><span>NEXTAMP PRO</span>
            </div>
            <div class="flex gap-1 items-center">
              <div
                id="engine-status"
                class="w-2 h-2 rounded-full bg-red-900 border border-black mr-1"
                title="Engine Status"
              ></div>
              <button
                onclick="openSettingsModal()"
                class="w-3 h-3 bg-btn-face text-black flex items-center justify-center border border-white text-[8px] leading-none"
              >
                O
              </button>
              <button
                class="w-3 h-3 bg-btn-face text-black flex items-center justify-center border border-white text-[8px] leading-none"
              >
                X
              </button>
            </div>
          </div>
          <div class="p-2">
            <div
              class="grid grid-cols-5 border border-gray-600 border-r-white/50 border-b-white/50 p-2 mb-2 flex gap-2 h-[94px] shadow-inner relative overflow-hidden"
            >
              <div
                class="col-span-2 bg-black border border-gray-700 relative overflow-hidden cursor-pointer"
                id="visualizer-container"
                title="Click to change visualizer style"
              >
                <div
                  id="time-display"
                  class="absolute top-1 right-1 font-pixel text-2xl theme-text-main leading-none tracking-widest text-shadow z-20"
                >
                  00:00
                </div>

                <div
                  class="absolute top-0.5 left-0.5 font-pixel theme-text-main text-[5px] z-30 opacity-70 pointer-events-none"
                >
                  VIS:<span id="v-status-indicator">SPEC</span>
                </div>

                <canvas
                  id="visualizer"
                  class="w-full h-full absolute bottom-0 left-0 block"
                ></canvas>
              </div>

              <div class="col-span-3 flex-1 flex flex-col gap-1.5 bg-[#292929]">
                <div
                  id="marquee"
                  class="font-pixel theme-text-main text-[11px] whitespace-nowrap overflow-hidden text-ellipsis leading-tight text-shadow bg-black border border-gray-800 px-2 py-1.5"
                >
                  System Ready.
                </div>

                <div class="flex justify-between items-center">
                  <div class="flex gap-2 items-center">
                    <span
                      id="info-bitrate"
                      class="font-pixel theme-text-sec text-[9px] leading-none"
                    >
                      -- kbps
                    </span>
                    <span
                      id="info-samplerate"
                      class="font-pixel theme-text-sec text-[9px] leading-none"
                    >
                      -- khz
                    </span>
                  </div>
                  <button
                    id="btn-mono-stereo"
                    class="font-pixel theme-text-main text-[8px] leading-none border border-gray-600 px-1 py-[1px] bg-black hover:bg-gray-800 cursor-pointer"
                  >
                    STEREO
                  </button>
                </div>

                <div class="flex gap-3 items-center">
                  <div class="flex flex-col flex-1">
                    <div
                      class="flex justify-between text-[8px] theme-text-main font-pixel mb-0.5"
                    >
                      <span>VOL</span><span id="txt-vol">80%</span>
                    </div>
                    <input
                      type="range"
                      id="main-vol"
                      min="0"
                      max="1"
                      step="0.01"
                      value="0.8"
                      class="w-full h-2 bg-black"
                      data-tooltip-type="percent"
                    />
                  </div>

                  <div class="flex flex-col flex-1">
                    <div
                      class="flex justify-between text-[8px] theme-text-sec font-pixel mb-0.5"
                    >
                      <span>L</span><span>BAL</span><span>R</span>
                    </div>
                    <input
                      type="range"
                      id="main-bal"
                      min="-1"
                      max="1"
                      step="0.1"
                      value="0"
                      class="w-full h-2 bg-black"
                      data-tooltip-type="balance"
                    />
                  </div>
                </div>
              </div>
            </div>

            <div class="flex flex-col gap-1 mb-2">
              <div class="relative h-4">
                <input
                  type="range"
                  id="playback"
                  min="0"
                  max="1"
                  step="0.001"
                  value="0"
                  class="w-full h-3 cursor-pointer"
                  data-tooltip-type="time"
                />
              </div>
            </div>

            <!-- Control Buttons -->
            <div class="flex justify-between items-end">
              <div class="flex gap-[2px]">
                <button id="btn-prev" class="win-btn w-8 h-8" title="Prev">
                  <i class="ph-fill ph-skip-back"></i>
                </button>
                <button id="btn-play" class="win-btn w-10 h-8" title="Play">
                  <i class="ph-fill ph-play text-base"></i>
                </button>
                <button id="btn-pause" class="win-btn w-10 h-8" title="Pause">
                  <i class="ph-fill ph-pause text-base"></i>
                </button>
                <button id="btn-stop" class="win-btn w-10 h-8" title="Stop">
                  <i class="ph-fill ph-stop text-base"></i>
                </button>
                <button id="btn-next" class="win-btn w-8 h-8" title="Next">
                  <i class="ph-fill ph-skip-forward"></i>
                </button>
              </div>

              <div class="flex flex-col gap-[2px]">
                <button
                  id="tog-shuffle"
                  class="retro-txt-btn w-12 h-4 text-[9px]"
                  title="Shuffle"
                >
                  SHUFFLE
                </button>
                <button
                  id="tog-repeat"
                  class="retro-txt-btn w-12 h-4 text-[9px]"
                  title="Repeat Mode"
                >
                  REPEAT
                </button>
              </div>
            </div>
          </div>
        </div>

        <div
          class="bg-[#292929] border-t-2 border-l-2 border-gray-500 border-r-2 border-b-2 border-black relative z-10 shadow-lg"
        >
          <div
            class="theme-bar h-4 flex justify-between items-center px-1 border-b border-black text-[10px] font-bold cursor-pointer"
            onclick="toggleSection('eq-body')"
          >
            <span>EQUALIZER</span><i class="ph-bold ph-caret-down"></i>
          </div>
          <div id="eq-body" class="p-2 flex gap-1 h-[160px]">
            <div
              class="w-[85px] flex flex-col justify-between pr-2 border-r border-gray-600"
            >
              <select
                id="eq-preset-select"
                class="w-full text-[9px] bg-black theme-text-main border border-gray-500 outline-none h-4"
              >
                <option value="flat">Flat</option>
                <option value="rock">Rock</option>
                <option value="pop">Pop</option>
                <option value="jazz">Jazz</option>
                <option value="fullbass">Bass</option>
                <option value="custom">Manual</option>
              </select>
              <div class="">
                <div class="flex justify-between items-center w-full">
                  <a
                    href="https://github.com/signalsmith-audio/signalsmith-stretch"
                    target="_blank"
                    class="bg-btn-face text-black px-[1px] py-[1px] no-underline flex items-center justify-center gap-1 w-full"
                  >
                    <i class="ph-bold ph-github-logo text-[10px]"></i>
                    <span class="text-[6px]"> Signalsmith Lib </span>
                  </a>
                </div>
                <div
                  class="flex justify-between text-[8px] text-gray-400 -mb-2"
                >
                  <span>PITCH</span
                  ><span id="val-pitch" class="theme-text-sec">0</span>
                </div>
                <input
                  type="range"
                  data-key="semitones"
                  min="-12"
                  max="12"
                  step="1"
                  value="0"
                  class="w-full h-1 bg-gray-600"
                  data-tooltip-type="val"
                />
              </div>
              <div class="">
                <div
                  class="flex justify-between text-[8px] text-gray-400 -mb-2"
                >
                  <span>SPEED</span
                  ><span id="val-rate" class="theme-text-sec">1.0</span>
                </div>
                <input
                  type="range"
                  data-key="rate"
                  min="0.5"
                  max="2"
                  step="0.05"
                  value="1"
                  class="w-full h-1 bg-gray-600"
                  data-tooltip-type="x"
                />
              </div>
              <div class="">
                <div
                  class="flex justify-between text-[8px] text-gray-400 -mb-2"
                >
                  <span>REVERB</span
                  ><span id="val-reverb" class="theme-text-sec">0.0</span>
                </div>
                <input
                  type="range"
                  data-key="reverb"
                  min="0"
                  max="2"
                  step="0.05"
                  value="0"
                  class="w-full h-1 bg-gray-600"
                  data-tooltip-type="x"
                />
              </div>
            </div>
            <div class="flex-1 flex flex-col relative">
              <div
                class="flex items-center mb-2 h-[35px] border border-gray-600 bg-black p-[2px]"
              >
                <canvas
                  id="eq-graph"
                  class="flex-1 h-full bg-[#111] border border-gray-800"
                  width="180"
                  height="30"
                ></canvas>
                <button
                  id="btn-eq-toggle"
                  class="win-btn h-full w-12 text-[9px] flex flex-col gap-0 leading-none"
                >
                  <span>EQ</span
                  ><span id="txt-eq-status" class="text-[7px]">ON</span>
                </button>
              </div>
              <div
                class="flex-1 flex gap-1 pb-1 px-1 bg-black border border-gray-600 shadow-inner relative"
                id="eq-container"
              ></div>
            </div>
          </div>
        </div>
      </div>

      <div
        class="bg-[#292929] border-t-2 border-l-2 border-gray-500 border-r-2 border-b-2 border-black relative z-0 shadow-lg flex-1 min-h-0 flex flex-col mt-2"
      >
        <div
          class="theme-bar h-4 flex justify-between items-center px-1 border-b border-black text-[10px] font-bold flex-none"
        >
          <span>LIBRARY & PLAYLIST</span>
        </div>
        <div class="p-2 flex flex-col h-full relative overflow-hidden">
          <div class="flex justify-between mb-1 flex-none">
            <select
              id="playlist-select"
              class="bg-black theme-text-main border border-gray-600 text-[10px] px-1 h-5 w-32 font-pixel focus:outline-none"
            >
              <option value="main">Main Library</option>
            </select>
            <div class="flex gap-1">
              <button
                onclick="openNewPlaylistModal()"
                class="win-btn px-2 h-5 text-[9px] font-bold shadow-sm"
              >
                NEW
              </button>
              <button
                onclick="handleDeletePlaylist()"
                id="btn-del-pl"
                class="win-btn px-2 h-5 text-[9px] font-bold text-red-900 shadow-sm hidden"
                title="Delete Playlist"
              >
                <i class="ph-bold ph-trash"></i>
              </button>
            </div>
          </div>

          <div
            class="flex-1 bg-black border-2 border-gray-600 border-r-white/50 border-b-white/50 overflow-y-auto custom-scroll p-1 font-pixel text-xs mb-2 shadow-inner select-none min-h-0"
            id="pl-box"
          >
            <div class="text-gray-500 text-center mt-10 text-[10px]">
              Drop files or Click ADD...
            </div>
          </div>

          <div class="flex justify-between items-center h-6 flex-none">
            <div class="flex gap-1">
              <button
                id="btn-pl-add"
                class="win-btn px-2 h-6 text-[10px] gap-1 font-bold shadow-sm"
              >
                <i class="ph-bold ph-plus"></i> ADD
              </button>
              <button
                onclick="handleDeleteTracks()"
                id="btn-del-track"
                class="win-btn px-2 h-6 text-[10px] gap-1 font-bold shadow-sm text-gray-500 cursor-default"
                disabled
              >
                <i class="ph-bold ph-minus"></i> REM
              </button>
              <button
                onclick="openAddToModal()"
                class="win-btn px-2 h-6 text-[10px] gap-1 font-bold shadow-sm"
              >
                <i class="ph-bold ph-list-plus"></i> TO...
              </button>
              <button
                onclick="moveTrack(-1)"
                id="btn-move-up"
                class="win-btn px-2 h-6 text-[10px] gap-1 font-bold shadow-sm text-gray-500 cursor-default"
                disabled
              >
                <i class="ph-bold ph-caret-up"></i>
              </button>
              <button
                onclick="moveTrack(1)"
                id="btn-move-down"
                class="win-btn px-2 h-6 text-[10px] gap-1 font-bold shadow-sm text-gray-500 cursor-default"
                disabled
              >
                <i class="ph-bold ph-caret-down"></i>
              </button>
            </div>
            <div class="font-pixel theme-text-main text-[10px]" id="pl-count">
              0 TRACKS
            </div>
          </div>
        </div>
      </div>

      <div
        id="modal-generic"
        class="absolute inset-0 bg-black/80 z-[200] flex items-center justify-center hidden"
      >
        <div class="bg-[#292929] border-2 border-white w-64 p-3 shadow-2xl">
          <div class="theme-bar px-2 py-1 text-[10px] font-bold mb-3">
            SYSTEM MESSAGE
          </div>
          <div
            id="modal-generic-msg"
            class="text-white text-xs mb-4 text-center font-ui px-2"
          ></div>
          <div class="flex gap-2 justify-center" id="modal-generic-btns"></div>
        </div>
      </div>
      <div
        id="modal-add-to"
        class="absolute inset-0 bg-black/80 z-50 flex items-center justify-center hidden"
      >
        <div class="bg-[#292929] border-2 border-white w-48 p-2 shadow-2xl">
          <div
            class="theme-text-main font-pixel text-center mb-2 border-b border-gray-600 pb-1"
          >
            SELECT PLAYLIST
          </div>
          <div
            id="modal-list"
            class="flex flex-col gap-1 max-h-32 overflow-y-auto custom-scroll"
          ></div>
          <button
            onclick="closeAddToModal()"
            class="win-btn w-full mt-2 h-5 text-[9px]"
          >
            CANCEL
          </button>
        </div>
      </div>
      <div
        id="modal-new-playlist"
        class="absolute inset-0 bg-black/80 z-50 flex items-center justify-center hidden"
      >
        <div class="bg-[#292929] border-2 border-white w-56 p-3 shadow-2xl">
          <div
            class="theme-text-main font-pixel text-center mb-3 border-b border-gray-600 pb-1 text-xs"
          >
            CREATE NEW PLAYLIST
          </div>
          <input
            type="text"
            id="new-playlist-name"
            class="w-full bg-black text-white border border-gray-500 text-xs p-1 mb-3 font-pixel focus:outline-none focus:border-win-green"
            placeholder="Playlist Name..."
          />
          <div class="flex gap-2">
            <button
              onclick="closeNewPlaylistModal()"
              class="win-btn flex-1 h-6 text-[10px]"
            >
              CANCEL
            </button>
            <button
              onclick="confirmNewPlaylist()"
              class="win-btn flex-1 h-6 text-[10px]"
            >
              CREATE
            </button>
          </div>
        </div>
      </div>

      <div
        id="modal-settings"
        class="absolute inset-0 bg-black/80 z-50 flex items-center justify-center hidden"
      >
        <div
          class="bg-[#292929] border-2 border-white w-64 p-3 shadow-2xl overflow-y-auto max-h-[90%]"
        >
          <div
            class="theme-bar px-2 py-1 text-[10px] font-bold mb-3 flex justify-between"
          >
            <span>APPEARANCE SETTINGS</span
            ><button onclick="closeSettingsModal()">X</button>
          </div>
          <div class="space-y-3 mb-4">
            <div class="flex items-center justify-between">
              <span class="text-white text-[10px] font-ui">Window Color</span>
              <input
                type="color"
                id="set-theme-window"
                class="h-5 w-8 p-0 border-0"
                onchange="previewTheme()"
              />
            </div>
            <div class="flex items-center justify-between">
              <span class="text-white text-[10px] font-ui"
                >Text/Icon Color</span
              >
              <input
                type="color"
                id="set-theme-text"
                class="h-5 w-8 p-0 border-0"
                onchange="previewTheme()"
              />
            </div>
            <div class="flex items-center justify-between">
              <span class="text-white text-[10px] font-ui"
                >Highlight Color</span
              >
              <input
                type="color"
                id="set-theme-high"
                class="h-5 w-8 p-0 border-0"
                onchange="previewTheme()"
              />
            </div>
            <div class="border-t border-gray-600 my-2"></div>
            <div class="text-[9px] text-gray-400 mb-1">EQ BAR GRADIENT</div>
            <div class="flex justify-between gap-1">
              <div class="flex flex-col items-center">
                <span class="text-[8px] text-gray-500">LOW</span
                ><input
                  type="color"
                  id="set-eq-1"
                  class="h-4 w-6 p-0 border-0"
                  onchange="previewTheme()"
                />
              </div>
              <div class="flex flex-col items-center">
                <span class="text-[8px] text-gray-500">MID</span
                ><input
                  type="color"
                  id="set-eq-2"
                  class="h-4 w-6 p-0 border-0"
                  onchange="previewTheme()"
                />
              </div>
              <div class="flex flex-col items-center">
                <span class="text-[8px] text-gray-500">HIGH</span
                ><input
                  type="color"
                  id="set-eq-3"
                  class="h-4 w-6 p-0 border-0"
                  onchange="previewTheme()"
                />
              </div>
            </div>
            <div
              class="border border-gray-600 h-8 w-full mt-2 relative"
              id="theme-preview-box"
            >
              <div
                class="absolute inset-0 flex items-center justify-center text-[10px] font-bold"
                id="theme-preview-text"
              >
                PREVIEW
              </div>
            </div>
            <button
              onclick="resetTheme()"
              class="win-btn w-full h-6 text-[10px] text-red-900 mt-2"
            >
              RESET DEFAULT
            </button>
          </div>
          <div class="flex gap-2">
            <button
              onclick="closeSettingsModal()"
              class="win-btn flex-1 h-6 text-[10px]"
            >
              CANCEL
            </button>
            <button
              onclick="applyThemeSettings()"
              class="win-btn flex-1 h-6 text-[10px]"
            >
              APPLY
            </button>
          </div>
        </div>
      </div>
    </div>

    <input
      type="file"
      id="upload-file"
      hidden
      multiple
      accept="audio/*,.mp3,.wav,.m4a,.ogg"
    />
    <script type="module">
      import SignalsmithStretch from "/assets/libs/mjs/SignalsmithStretch.mjs";
      const $ = (s) => document.querySelector(s);
      const $$ = (s) => document.querySelectorAll(s);
      const STORAGE_KEY = "nextamp_settings_v9_stable";

      const defaultTheme = {
        window: "#000080",
        text: "#00ff00",
        textSec: "#ffcc00",
        highlight: "#000080",
        eq1: "#00ff00",
        eq2: "#ffff00",
        eq3: "#ff0000",
      };
      let currentTheme = { ...defaultTheme };

      function applyThemeToDOM(t) {
        const r = document.documentElement;
        r.style.setProperty("--theme-window", t.window);
        r.style.setProperty("--theme-text", t.text);
        r.style.setProperty("--theme-text-sec", t.textSec);
        r.style.setProperty("--theme-highlight", t.highlight);
        r.style.setProperty("--eq-col-1", t.eq1);
        r.style.setProperty("--eq-col-2", t.eq2);
        r.style.setProperty("--eq-col-3", t.eq3);
      }

      // MODALS
      window.customAlert = (msg) => {
        $("#modal-generic-msg").textContent = msg;
        const btns = $("#modal-generic-btns");
        btns.innerHTML = "";
        const ok = document.createElement("button");
        ok.className = "win-btn w-20 h-6 text-[10px]";
        ok.textContent = "OK";
        ok.onclick = () => $("#modal-generic").classList.add("hidden");
        btns.appendChild(ok);
        $("#modal-generic").classList.remove("hidden");
      };

      window.customConfirm = (msg, callback) => {
        $("#modal-generic-msg").textContent = msg;
        const btns = $("#modal-generic-btns");
        btns.innerHTML = "";
        const no = document.createElement("button");
        no.className = "win-btn w-20 h-6 text-[10px]";
        no.textContent = "NO";
        no.onclick = () => {
          $("#modal-generic").classList.add("hidden");
        };
        const yes = document.createElement("button");
        yes.className = "win-btn w-20 h-6 text-[10px]";
        yes.textContent = "YES";
        yes.onclick = () => {
          $("#modal-generic").classList.add("hidden");
          callback();
        };
        btns.appendChild(no);
        btns.appendChild(yes);
        $("#modal-generic").classList.remove("hidden");
      };

      // SETTINGS UI
      window.openSettingsModal = () => {
        $("#modal-settings").classList.remove("hidden");
        $("#set-theme-window").value = currentTheme.window;
        $("#set-theme-text").value = currentTheme.text;
        $("#set-theme-high").value = currentTheme.highlight;
        $("#set-eq-1").value = currentTheme.eq1;
        $("#set-eq-2").value = currentTheme.eq2;
        $("#set-eq-3").value = currentTheme.eq3;
        previewTheme();
      };
      window.closeSettingsModal = () =>
        $("#modal-settings").classList.add("hidden");
      window.previewTheme = () => {
        const w = $("#set-theme-window").value;
        const t = $("#set-theme-text").value;
        const bg = $("#theme-preview-box");
        const txt = $("#theme-preview-text");
        bg.style.backgroundColor = w;
        txt.style.color = t;
      };
      window.applyThemeSettings = () => {
        currentTheme.window = $("#set-theme-window").value;
        currentTheme.text = $("#set-theme-text").value;
        currentTheme.highlight = $("#set-theme-high").value;
        currentTheme.eq1 = $("#set-eq-1").value;
        currentTheme.eq2 = $("#set-eq-2").value;
        currentTheme.eq3 = $("#set-eq-3").value;
        applyThemeToDOM(currentTheme);
        saveSettings();
        closeSettingsModal();
      };
      window.resetTheme = () => {
        currentTheme = { ...defaultTheme };
        applyThemeToDOM(currentTheme);
        saveSettings();
        closeSettingsModal();
      };

      // TOOLTIPS
      const tooltip = $("#slider-tooltip");
      const hideTooltip = () => {
        tooltip.style.display = "none";
      };
      function attachTooltips() {
        $$('input[type="range"]').forEach((el) => {
          el.oninput = (e) => {
            const val = parseFloat(e.target.value);
            let text = val;
            const type = el.dataset.tooltipType || "raw";
            if (type === "time") text = formatTime(val);
            else if (type === "percent") text = Math.round(val * 100) + "%";
            else if (type === "balance")
              text =
                val === 0
                  ? "CENTER"
                  : val < 0
                  ? "L " + Math.abs(val)
                  : "R " + val;
            else if (type === "x") text = val + "x";
            else if (type === "val") text = val;
            else if (type === "db") text = val + " dB";

            if (el.dataset.idx) {
              handleEqInput(el.dataset.idx, val, el);
              text = val + " dB";
            } else {
              if (el.id === "main-vol") {
                masterGainNode.gain.value = val;
                $("#txt-vol").textContent = Math.round(val * 100) + "%";
                saveSettings();
              } else if (el.id === "main-bal") {
                pannerNode.pan.value = val;
                saveSettings();
              } else if (el.dataset.key === "rate") {
                controlValues.rate = val;
                $("#val-rate").textContent = val.toFixed(2);
                controlsChanged();
                saveSettings();
              } else if (el.dataset.key === "reverb") {
                const val = parseFloat(el.value);
                reverbGain.gain.value = val;
                $("#val-reverb").textContent = val.toFixed(1);
                controlsChanged();
                saveSettings();
              } else if (el.dataset.key === "semitones") {
                controlValues.semitones = val;
                $("#val-pitch").textContent = val;
                controlsChanged();
                saveSettings();
              } else if (el.id === "playback" && stretch) {
                stretch.schedule({ input: val, rate: 0 });
              }
            }
            const rect = el.getBoundingClientRect();
            tooltip.textContent = text;
            tooltip.style.display = "block";
            if (el.classList.contains("vertical")) {
              tooltip.style.left = rect.right + 5 + "px";
              const min = parseFloat(el.min),
                max = parseFloat(el.max),
                percent = (val - min) / (max - min);
              const topPos = rect.bottom - rect.height * percent;
              tooltip.style.top = topPos - 10 + "px";
            } else {
              tooltip.style.top = rect.top - 25 + "px";
              const min = parseFloat(el.min),
                max = parseFloat(el.max),
                percent = (val - min) / (max - min);
              const leftPos = rect.left + rect.width * percent;
              tooltip.style.left = leftPos - tooltip.offsetWidth / 2 + "px";
            }
          };
        });
      }
      window.addEventListener("mouseup", hideTooltip);
      window.addEventListener("touchend", hideTooltip);
      window.formatTime = (t) => {
        t = parseFloat(t);
        if (isNaN(t)) return "00:00";
        return `${Math.floor(t / 60)}:${Math.floor(t % 60)
          .toString()
          .padStart(2, "0")}`;
      };

      // STORAGE (EQ FIX: Read from sliders)
      function saveSettings() {
        const settings = {
          vol: $("#main-vol").value,
          bal: $("#main-bal").value,
          rate: controlValues.rate,
          pitch: controlValues.semitones,
          reverb: controlValues.reverb,
          isShuffle: isShuffle,
          repeatMode: repeatMode,
          isEqOn: isEqOn,
          playlistId: currentPlaylistId,
          eqGains: Array.from(document.querySelectorAll("input[data-idx]")).map(
            (inp) => parseFloat(inp.value)
          ),
          isMono: isMono,
          theme: currentTheme,
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(settings));
      }
      function loadSettings() {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) {
          applyThemeToDOM(defaultTheme);
          return;
        }
        const s = JSON.parse(raw);
        if (s.vol) {
          $("#main-vol").value = s.vol;
          masterGainNode.gain.value = parseFloat(s.vol);
          $("#txt-vol").textContent = Math.round(s.vol * 100) + "%";
        }
        if (s.bal) {
          $("#main-bal").value = s.bal;
          pannerNode.pan.value = parseFloat(s.bal);
        }
        if (s.rate) {
          controlValues.rate = parseFloat(s.rate);
          $('input[data-key="rate"]').value = s.rate;
          $("#val-rate").textContent = s.rate.toFixed(2);
        }
        if (s.pitch) {
          controlValues.semitones = parseFloat(s.pitch);
          $('input[data-key="semitones"]').value = s.pitch;
          $("#val-pitch").textContent = s.pitch;
        }
        if (s.reverb) {
          controlValues.reverb = parseFloat(s.reverb);
          $('input[data-key="reverb"]').value = s.reverb;
          $("#val-reverb").textContent = s.reverb;
        }
        if (s.isShuffle) {
          isShuffle = true;
          $("#tog-shuffle").classList.add("active");
        }
        if (s.repeatMode !== undefined) repeatMode = s.repeatMode;
        updateRepeatBtn();
        if (s.isMono !== undefined) isMono = s.isMono;
        updateMonoStereoState();
        isEqOn = s.isEqOn !== undefined ? s.isEqOn : true;
        $("#txt-eq-status").textContent = isEqOn ? "ON" : "OFF";
        $("#btn-eq-toggle").classList.toggle("pressed", isEqOn);
        if (s.playlistId) currentPlaylistId = s.playlistId;
        if (s.theme) {
          currentTheme = s.theme;
          applyThemeToDOM(currentTheme);
        } else {
          applyThemeToDOM(defaultTheme);
        }
        window.savedEqGains = s.eqGains || [];
      }

      // AUDIO ENGINE
      const audioContext = new AudioContext();
      let isEngineHot = false;
      const audioStartup = $("#audio-startup"),
        audioLoop = $("#audio-loop");
      const loopSource = audioContext.createMediaElementSource(audioLoop);
      loopSource.connect(audioContext.destination);

      // AUTO INIT ON FIRST CLICK
      const initAudioEngine = async () => {
        if (isEngineHot) return;
        try {
          if (audioContext.state === "suspended") await audioContext.resume();
          isEngineHot = true;
          audioStartup.volume = 0.5;
          audioLoop.volume = 0.05;
          await audioStartup.play();
          audioLoop.play().catch((e) => {});

          // Visual Cue: Change Engine Status to Green
          $("#engine-status").style.backgroundColor = "#00ff00";
          $("#engine-status").style.boxShadow = "0 0 4px #0f0";
          $("#marquee").textContent = "Ready.";
        } catch (e) {
          console.error("Init failed", e);
        }
      };

      // Listen for the first click anywhere to start the engine
      document.addEventListener("click", initAudioEngine, { once: true });
      document.addEventListener("touchstart", initAudioEngine, { once: true });

      const checkAndResumeAudioContext = () => {
        if (
          isEngineHot &&
          (audioContext.state === "suspended" ||
            audioContext.state === "interrupted")
        )
          audioContext.resume();
        if (isEngineHot && audioLoop.paused) audioLoop.play().catch((e) => {});
      };
      setInterval(checkAndResumeAudioContext, 1000);
      ["visibilitychange", "touchstart", "click"].forEach((evt) =>
        document.addEventListener(evt, checkAndResumeAudioContext)
      );

      let stretch = null,
        eqNodes = [],
        reverbNode = audioContext.createConvolver(),
        reverbGain = audioContext.createGain(),
        analyser = audioContext.createAnalyser();
      let masterGainNode = audioContext.createGain(),
        pannerNode = audioContext.createStereoPanner();

      // DUAL PATH MONO/STEREO
      let stereoPath = audioContext.createGain();
      let monoPath = audioContext.createGain();

      reverbGain.gain.value = 0;
      monoPath.channelCount = 1;
      monoPath.channelCountMode = "explicit";
      monoPath.channelInterpretation = "speakers";

      let isMono = false,
        audioDuration = 1,
        isChangingTrack = false,
        playDebounceTimer = null;

      analyser.connect(stereoPath);
      analyser.connect(monoPath);
      stereoPath.connect(pannerNode);
      monoPath.connect(pannerNode);

      pannerNode.connect(masterGainNode);
      masterGainNode.connect(audioContext.destination);
      masterGainNode.gain.value = 0.8;
      analyser.fftSize = 256;

      const FREQUENCIES = [
        60, 170, 310, 600, 1000, 3000, 6000, 12000, 14000, 16000,
      ];
      const PRESETS = {
        flat: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        rock: [4, 3, 2, 0, -1, -1, 0, 2, 3, 4],
        pop: [-1, 1, 3, 3, 1, -1, -2, -2, -1, -1],
        jazz: [3, 2, 0, -2, -2, 0, 2, 3, 4, 4],
        fullbass: [6, 6, 5, 2, 0, -2, -4, -5, -6, -6],
      };
      let controlValues = { active: false, rate: 1, semitones: 0 },
        isEqOn = true;

      // FIXED EQ INIT
      function initEQ() {
        eqNodes.forEach((n) => {
          try {
            n.disconnect();
          } catch (e) {}
        });
        eqNodes = [];
        let prev = null,
          first = null;
        FREQUENCIES.forEach((freq, i) => {
          const f = audioContext.createBiquadFilter();
          f.type = "peaking";
          f.frequency.value = freq;
          f.Q.value = 1.4;

          const slider = document.querySelector(`input[data-idx="${i}"]`);
          let targetVal = 0;
          if (slider) {
            targetVal = parseFloat(slider.value);
          } else {
            targetVal =
              window.savedEqGains && window.savedEqGains[i] !== undefined
                ? window.savedEqGains[i]
                : 0;
          }

          if (slider) {
            slider.value = targetVal;
            updateThumb(slider, `thumb-${i}`);
          }

          f.gain.value = isEqOn ? targetVal : 0;
          eqNodes.push(f);
          if (prev) prev.connect(f);
          else first = f;
          prev = f;
        });
        return { input: first, output: prev };
      }

      function createImpulseResponse(
        duration = 4.5, // เพิ่มความยาวให้ก้องนานขึ้น
        decay = 2.2, // ลด decay ให้เสียงค่อย ๆ จางช้าขึ้น
        preDelay = 0.035 // เพิ่ม pre-delay เล็กน้อย
      ) {
        const sampleRate = audioContext.sampleRate;
        const length = sampleRate * duration;
        const impulse = audioContext.createBuffer(2, length, sampleRate);

        const preDelaySamples = Math.floor(preDelay * sampleRate);

        for (let ch = 0; ch < 2; ch++) {
          const data = impulse.getChannelData(ch);

          for (let i = 0; i < length; i++) {
            const t = i / length;
            const envelope = Math.exp(-decay * t);
            let noise = Math.random() * 2 - 1;
            const hfDamping = Math.pow(1 - t * 0.7, 3);
            const warmth = 1 - t * 0.3;
            data[i] = noise * envelope * hfDamping * warmth;
          }

          const reflections = [
            { delay: 0.025, gain: 0.5 },
            { delay: 0.045, gain: 0.42 },
            { delay: 0.068, gain: 0.35 },
            { delay: 0.095, gain: 0.28 },
            { delay: 0.125, gain: 0.22 },
            { delay: 0.16, gain: 0.18 },
            { delay: 0.2, gain: 0.15 },
            { delay: 0.245, gain: 0.12 },
          ];

          for (const ref of reflections) {
            const delaySamples = Math.floor(ref.delay * sampleRate);
            if (delaySamples < length) {
              for (let i = 0; i < 50; i++) {
                const idx = delaySamples + i;
                if (idx < length) {
                  const diffusion = (Math.random() * 2 - 1) * ref.gain;
                  const fade = 1 - i / 50;
                  data[idx] += diffusion * fade;
                }
              }
            }
          }
        }

        return impulse;
      }
      reverbNode.buffer = createImpulseResponse();

      async function loadAudioEngine(arrayBuffer, trackObj) {
        if (!isEngineHot) await initAudioEngine();
        checkAndResumeAudioContext();
        const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
        audioDuration = audioBuffer.duration;
        const channelBuffers = [];
        for (let c = 0; c < audioBuffer.numberOfChannels; ++c)
          channelBuffers.push(audioBuffer.getChannelData(c));
        if (stretch) {
          stretch.stop();
          stretch.disconnect();
        }
        stretch = await SignalsmithStretch(audioContext);
        const eqChain = initEQ();
        stretch.connect(eqChain.input);
        // แบ่งสัญญาณ:
        // 1. ส่งไป EQ ปกติ (Dry)
        eqChain.output.connect(analyser);

        // 2. ส่งไป Reverb (Wet)
        eqChain.output.connect(reverbNode);
        reverbNode.connect(reverbGain);
        reverbGain.connect(analyser); // รวมกลับไปที่ Analyser
        await stretch.addBuffers(channelBuffers);
        controlValues.active = true;
        controlsChanged();
        isChangingTrack = false;
        updateMediaSession(trackObj.name);
        $("#info-samplerate").textContent =
          audioBuffer.sampleRate / 1000 + " khz";
        if (trackObj.blob && trackObj.blob.size) {
          const kbps = Math.round(
            (trackObj.blob.size * 8) / audioDuration / 1000
          );
          $("#info-bitrate").textContent = kbps + " k";
        } else {
          $("#info-bitrate").textContent = "N/A";
        }
        attachTooltips();
      }
      function controlsChanged(scheduleAhead) {
        $("#btn-play").classList.toggle("pressed", controlValues.active);
        if (stretch) {
          let obj = Object.assign(
            { output: audioContext.currentTime + (scheduleAhead || 0) },
            controlValues
          );
          stretch.schedule(obj);
        }
        updatePositionState();
      }
      function updateMediaSession(trackName) {
        if ("mediaSession" in navigator) {
          navigator.mediaSession.metadata = new MediaMetadata({
            title: trackName,
            artist: "Nextamp Player",
            artwork: [
              {
                src: "https://next-amp-player.vercel.app/assets/logo/logo.png",
                sizes: "512x512",
                type: "image/png",
              },
            ],
          });
          navigator.mediaSession.setActionHandler("play", () =>
            $("#btn-play").click()
          );
          navigator.mediaSession.setActionHandler("pause", () =>
            $("#btn-pause").click()
          );
          navigator.mediaSession.setActionHandler("previoustrack", () =>
            $("#btn-prev").click()
          );
          navigator.mediaSession.setActionHandler("nexttrack", () =>
            $("#btn-next").click()
          );
          navigator.mediaSession.setActionHandler("seekto", (details) => {
            if (details.seekTime !== undefined && stretch) {
              stretch.schedule({ input: details.seekTime });
              updatePositionState();
            }
          });
          updatePositionState();
        }
      }
      function updatePositionState() {
        if ("mediaSession" in navigator && stretch) {
          try {
            navigator.mediaSession.setPositionState({
              duration: audioDuration || 0,
              playbackRate: controlValues.active ? controlValues.rate : 0,
              position: stretch.inputTime || 0,
            });
          } catch (e) {}
        }
      }

      let LIBRARY = [],
        playlists = { main: { name: "Main Library", trackIds: [] } },
        currentPlaylistId = "main",
        currentTrackIndex = -1,
        selectedIndices = new Set(),
        lastSelectedIndex = -1;
      const DB_NAME = "NextampUltimateDB",
        dbReq = indexedDB.open(DB_NAME, 8);
      dbReq.onupgradeneeded = (e) => {
        const db = e.target.result;
        if (!db.objectStoreNames.contains("library"))
          db.createObjectStore("library", { keyPath: "id" });
        if (!db.objectStoreNames.contains("playlists"))
          db.createObjectStore("playlists", { keyPath: "id" });
      };
      dbReq.onsuccess = async (e) => {
        await loadLibraryFromDB();
        await loadPlaylistsFromDB();
        loadSettings();
        renderPlaylistSelect();
        renderPlaylistUI();
        initEQ();
        drawEQCurve();
        attachTooltips();
      };
      async function saveTrackToLib(track) {
        const db = dbReq.result;
        const tx = db.transaction("library", "readwrite");
        tx.objectStore("library").put(track);
      }
      async function deleteTrackFromLib(id) {
        const db = dbReq.result;
        const tx = db.transaction("library", "readwrite");
        tx.objectStore("library").delete(id);
      }
      async function savePlaylistsToDB(plObj) {
        const db = dbReq.result;
        const tx = db.transaction("playlists", "readwrite");
        tx.objectStore("playlists").put(plObj);
      }
      async function loadLibraryFromDB() {
        return new Promise((resolve) => {
          const db = dbReq.result;
          const tx = db.transaction("library", "readonly");
          const req = tx.objectStore("library").getAll();
          req.onsuccess = () => {
            LIBRARY = req.result || [];
            resolve();
          };
        });
      }
      async function loadPlaylistsFromDB() {
        return new Promise((resolve) => {
          const db = dbReq.result;
          const tx = db.transaction("playlists", "readonly");
          const req = tx.objectStore("playlists").getAll();
          req.onsuccess = () => {
            if (req.result) req.result.forEach((p) => (playlists[p.id] = p));
            resolve();
          };
        });
      }
      const getTrackById = (id) => LIBRARY.find((t) => t.id === id);
      function getCurrentDisplayList() {
        if (currentPlaylistId === "main") return LIBRARY;
        return playlists[currentPlaylistId].trackIds
          .map((id) => getTrackById(id))
          .filter((t) => t);
      }

      async function playTrack(idx) {
        if (!isEngineHot) await initAudioEngine(); // Force init if first track play
        if (playDebounceTimer) clearTimeout(playDebounceTimer);
        let list = getCurrentDisplayList();
        if (idx < 0 || idx >= list.length) return;
        currentTrackIndex = idx;
        renderPlaylistUI();
        const t = list[idx];
        $("#marquee").textContent = `${idx + 1}. ${t.name} (Loading...)`;
        playDebounceTimer = setTimeout(async () => {
          isChangingTrack = true;
          checkAndResumeAudioContext();
          try {
            const buf = await t.blob.arrayBuffer();
            await loadAudioEngine(buf, t);
            $("#marquee").textContent = `${idx + 1}. ${t.name}`;
          } catch (e) {
            $("#marquee").textContent = "Error loading file.";
            isChangingTrack = false;
          }
        }, 200);
      }
      function handleNextTrack(auto = false) {
        let list = getCurrentDisplayList();
        if (list.length === 0) return;
        let next;
        if (auto && repeatMode === 2) next = currentTrackIndex;
        else if (isShuffle) {
          if (list.length > 1) {
            do {
              next = Math.floor(Math.random() * list.length);
            } while (next === currentTrackIndex);
          } else next = 0;
        } else next = currentTrackIndex + 1;
        if (next < list.length) playTrack(next);
        else if (repeatMode === 1) playTrack(0);
        else if (!auto) playTrack(0);
      }
      function handlePrevTrack() {
        let list = getCurrentDisplayList();
        if (list.length === 0) return;
        let prev = isShuffle
          ? Math.floor(Math.random() * list.length)
          : currentTrackIndex - 1;
        if (prev < 0) prev = repeatMode === 1 ? list.length - 1 : 0;
        playTrack(prev);
      }
      $("#btn-play").onclick = async () => {
        if (!isEngineHot) await initAudioEngine();
        checkAndResumeAudioContext();
        const list = getCurrentDisplayList();
        if (!stretch && list.length > 0)
          playTrack(Math.max(0, currentTrackIndex));
        else if (stretch) {
          controlValues.active = !controlValues.active;
          controlsChanged(0.1);
        }
      };
      $("#btn-pause").onclick = () => {
        controlValues.active = false;
        controlsChanged();
      };
      $("#btn-stop").onclick = () => {
        controlValues.active = false;
        if (stretch) stretch.stop();
        $("#playback").value = 0;
        $("#time-display").textContent = "00:00";
        $("#btn-play").classList.remove("pressed");
        $("#marquee").textContent = "Stopped.";
        updatePositionState();
      };
      $("#btn-next").onclick = () => handleNextTrack(false);
      $("#btn-prev").onclick = () => handlePrevTrack();

      const eqContainer = $("#eq-container"),
        eqCanvas = $("#eq-graph"),
        eqCtx = eqCanvas.getContext("2d");
      $("#btn-eq-toggle").onclick = () => {
        isEqOn = !isEqOn;
        $("#txt-eq-status").textContent = isEqOn ? "ON" : "OFF";
        $("#btn-eq-toggle").classList.toggle("pressed", isEqOn);
        $$("input[data-idx]").forEach((inp, i) => updateEqBand(i, inp.value));
        saveSettings();
      };
      FREQUENCIES.forEach((f, i) => {
        const div = document.createElement("div");
        div.className =
          "flex flex-col items-center h-full flex-1 group relative py-2";
        div.innerHTML = `<div class="relative h-full w-full flex justify-center"><div class="eq-bar-bg ${
          isEqOn ? "eq-bar-active" : ""
        }" id="eq-bg-${i}"></div><div class="eq-thumb" style="top: 50%" id="thumb-${i}"></div><input type="range" class="vertical" min="-12" max="12" step="0.5" value="0" data-idx="${i}" data-tooltip-type="db"></div><div class="absolute -bottom-1 text-[7px] theme-text-main font-pixel tracking-tighter">${
          f >= 1000 ? f / 1000 + "k" : f
        }</div>`;
        div.querySelector("input").ondblclick = (e) => {
          e.target.value = 0;
          handleEqInput(i, 0, e.target);
        };
        eqContainer.appendChild(div);
      });
      window.handleEqInput = (idx, val, el) => {
        if (isEqOn && $("#eq-preset-select").value !== "custom")
          $("#eq-preset-select").value = "custom";
        updateEqBand(idx, val);
        updateThumb(el, `thumb-${idx}`);
      };
      window.updateThumb = (input, thumbId) => {
        const min = parseFloat(input.min),
          max = parseFloat(input.max),
          val = parseFloat(input.value),
          percent = ((val - min) / (max - min)) * 100;
        $(`#${thumbId}`).style.top = `${100 - percent}%`;
      };
      window.updateEqBand = (idx, val) => {
        if (eqNodes[idx])
          eqNodes[idx].gain.value = isEqOn ? parseFloat(val) : 0;
        const bg = $(`#eq-bg-${idx}`);
        if (isEqOn) bg.classList.add("eq-bar-active");
        else bg.classList.remove("eq-bar-active");
        drawEQCurve();
        saveSettings();
      };
      function drawEQCurve() {
        eqCtx.clearRect(0, 0, eqCanvas.width, eqCanvas.height);
        eqCtx.strokeStyle = "#333";
        eqCtx.lineWidth = 1;
        eqCtx.beginPath();
        eqCtx.moveTo(0, 15);
        eqCtx.lineTo(180, 15);
        eqCtx.stroke();
        if (!isEqOn) return;
        eqCtx.strokeStyle = currentTheme.text;
        eqCtx.lineWidth = 2;
        eqCtx.beginPath();
        const stepX = eqCanvas.width / (FREQUENCIES.length - 1),
          points = [];
        FREQUENCIES.forEach((_, i) => {
          let gain = 0;
          if (eqNodes[i]) gain = eqNodes[i].gain.value;
          else {
            const inp = $(`input[data-idx="${i}"]`);
            gain = inp ? parseFloat(inp.value) : 0;
          }
          points.push({ x: i * stepX, y: 15 - gain * (15 / 14) });
        });
        eqCtx.moveTo(points[0].x, points[0].y);
        for (let i = 1; i < points.length - 2; i++) {
          const xc = (points[i].x + points[i + 1].x) / 2;
          const yc = (points[i].y + points[i + 1].y) / 2;
          eqCtx.quadraticCurveTo(points[i].x, points[i].y, xc, yc);
        }
        eqCtx.quadraticCurveTo(
          points[points.length - 2].x,
          points[points.length - 2].y,
          points[points.length - 1].x,
          points[points.length - 1].y
        );
        eqCtx.stroke();
      }
      $("#eq-preset-select").onchange = (e) => {
        const val = e.target.value;
        if (PRESETS[val])
          PRESETS[val].forEach((v, i) => {
            const inp = $(`input[data-idx="${i}"]`);
            inp.value = v;
            updateThumb(inp, `thumb-${i}`);
            updateEqBand(i, v);
          });
      };

      const cvs = $("#visualizer"),
        ctx = cvs.getContext("2d");
      const visualModeNames = ["BAR", "LINE", "WAVE", "OFF"];
      let visualMode = 0;

      $("#visualizer-container").onclick = () => {
        visualMode = (visualMode + 1) % 4;

        const indicator = $("#v-status-indicator");
        indicator.textContent = `${visualModeNames[visualMode]}`;

        indicator.style.opacity = visualMode === 3 ? "0.5" : "1";
      };
      function resizeCvs() {
        const r = cvs.parentElement.getBoundingClientRect();
        cvs.width = r.width;
        cvs.height = r.height;
      }
      window.addEventListener("resize", resizeCvs);
      setTimeout(resizeCvs, 500);

      let lastUpdateTime = 0;

      function draw(time) {
        requestAnimationFrame(draw);

        if (time - lastUpdateTime > 1000) {
          updatePositionState();
          lastUpdateTime = time;
        }
        if (stretch && !holding) {
          const pb = $("#playback");
          pb.max = audioDuration;
          const t = stretch.inputTime || 0;
          pb.value = t;
          $("#time-display").textContent = formatTime(t);
          if (
            controlValues.active &&
            t >= audioDuration - 0.2 &&
            !isChangingTrack
          )
            handleNextTrack(true);
        }

        ctx.fillStyle = "#111";
        ctx.fillRect(0, 0, cvs.width, cvs.height);

        if (visualMode === 3) return;

        const bufferLength = analyser.frequencyBinCount,
          dataArray = new Uint8Array(bufferLength);

        if (visualMode === 0) {
          analyser.getByteFrequencyData(dataArray);
          let gradient = ctx.createLinearGradient(0, cvs.height, 0, 0);
          gradient.addColorStop(0, currentTheme.eq1);
          gradient.addColorStop(0.6, currentTheme.eq2);
          gradient.addColorStop(1, currentTheme.eq3);
          ctx.fillStyle = gradient;
          const barWidth = (cvs.width / bufferLength) * 2.5;
          let x = 0;
          for (let i = 0; i < bufferLength; i++) {
            let barHeight = (dataArray[i] / 255) * cvs.height;
            if (barHeight > 0)
              ctx.fillRect(x, cvs.height - barHeight, barWidth - 1, barHeight);
            x += barWidth;
          }
        } else if (visualMode === 1) {
          analyser.getByteFrequencyData(dataArray);
          ctx.lineWidth = 2;
          ctx.strokeStyle = currentTheme.text;
          ctx.beginPath();
          const sliceWidth = (cvs.width * 1.0) / bufferLength;
          let x = 0;
          for (let i = 0; i < bufferLength; i++) {
            const v = dataArray[i] / 255.0;
            const y = cvs.height - v * cvs.height;
            if (i === 0) ctx.moveTo(x, y);
            else ctx.lineTo(x, y);
            x += sliceWidth;
          }
          ctx.stroke();
        } else if (visualMode === 2) {
          analyser.getByteTimeDomainData(dataArray);
          ctx.lineWidth = 2;
          ctx.strokeStyle = "#00ffff";
          ctx.beginPath();
          const sliceWidth = (cvs.width * 1.0) / bufferLength;
          let x = 0;
          for (let i = 0; i < bufferLength; i++) {
            const v = dataArray[i] / 128.0;
            const y = (v * cvs.height) / 2;
            if (i === 0) ctx.moveTo(x, y);
            else ctx.lineTo(x, y);
            x += sliceWidth;
          }
          ctx.stroke();
        }
      }
      requestAnimationFrame(draw);

      $("#pl-box").onclick = (e) => {
        if (
          e.target.id === "pl-box" ||
          e.target.classList.contains("text-center")
        ) {
          selectedIndices.clear();
          renderPlaylistUI();
        }
      };
      window.renderPlaylistUI = () => {
        const box = $("#pl-box");
        box.innerHTML = "";
        let displayList = getCurrentDisplayList();
        if (displayList.length === 0)
          box.innerHTML = `<div class="text-gray-500 text-center mt-10 text-[10px] pointer-events-none">${
            currentPlaylistId === "main"
              ? "Drop files or Click ADD..."
              : "Playlist empty."
          }</div>`;
        else {
          displayList.forEach((t, i) => {
            const d = document.createElement("div");
            if (selectedIndices.has(i)) d.classList.add("theme-highlight-bg");
            else d.className += " theme-text-main hover:bg-[#222]";
            let textClass = i === currentTrackIndex ? "text-white" : "";
            d.className += ` cursor-pointer px-1 flex justify-between select-none ${textClass}`;
            d.draggable = true;
            d.innerHTML = `<div class="flex truncate w-full pointer-events-none"><span class="w-6 text-right mr-2 flex-shrink-0">${
              i + 1
            }.</span><span class="truncate">${t.name}</span></div>`;
            d.ondragstart = (e) => {
              e.dataTransfer.setData("text/plain", i);
              d.classList.add("dragging");
            };
            d.ondragend = () => d.classList.remove("dragging");
            d.ondragover = (e) => {
              e.preventDefault();
              d.classList.add("drag-over");
            };
            d.ondragleave = () => d.classList.remove("drag-over");
            d.ondrop = (e) => {
              e.preventDefault();
              d.classList.remove("drag-over");
              handleDragDrop(parseInt(e.dataTransfer.getData("text/plain")), i);
            };

            // DOUBLE TAP FOR MOBILE
            let lastTapTime = 0;
            d.ontouchend = (e) => {
              const currentTime = new Date().getTime();
              const tapLength = currentTime - lastTapTime;
              if (tapLength < 300 && tapLength > 0) {
                e.preventDefault();
                playTrack(i);
              }
              lastTapTime = currentTime;
            };

            d.onclick = (e) => {
              e.stopPropagation();
              if (e.shiftKey && lastSelectedIndex !== -1) {
                const start = Math.min(lastSelectedIndex, i);
                const end = Math.max(lastSelectedIndex, i);
                selectedIndices.clear();
                for (let k = start; k <= end; k++) selectedIndices.add(k);
              } else if (e.ctrlKey || e.metaKey) {
                selectedIndices.has(i)
                  ? selectedIndices.delete(i)
                  : selectedIndices.add(i);
                lastSelectedIndex = i;
              } else {
                selectedIndices.clear();
                selectedIndices.add(i);
                lastSelectedIndex = i;
              }
              renderPlaylistUI();
            };
            d.ondblclick = () => playTrack(i);
            box.appendChild(d);
          });
        }
        $("#pl-count").textContent = `${displayList.length} TRACKS`;
        const hasSel = selectedIndices.size > 0;
        const toggleDisableStyle = (btnId, isDisabled) => {
          const btn = $(btnId);
          btn.disabled = isDisabled;
          if (isDisabled) {
            btn.classList.add("text-gray-500", "cursor-default");
            btn.classList.remove(
              "text-red-900",
              "text-black",
              "cursor-pointer"
            );
          } else {
            btn.classList.remove("text-gray-500", "cursor-default");
            btn.classList.add("cursor-pointer");
            if (btnId === "#btn-del-track") btn.classList.add("text-red-900");
            else btn.classList.add("text-black");
          }
        };
        toggleDisableStyle("#btn-del-track", !hasSel);
        toggleDisableStyle("#btn-move-up", !hasSel);
        toggleDisableStyle("#btn-move-down", !hasSel);
        $("#btn-del-pl").style.display =
          currentPlaylistId === "main" ? "none" : "block";
      };

      window.moveTrack = (dir) => {
        if (selectedIndices.size !== 1) return;
        const idx = Array.from(selectedIndices)[0];
        handleDragDrop(idx, idx + dir);
      };
      window.handleDragDrop = async (srcIdx, targetIdx) => {
        let list = getCurrentDisplayList();
        if (targetIdx < 0 || targetIdx >= list.length || srcIdx === targetIdx)
          return;
        const item = list.splice(srcIdx, 1)[0];
        list.splice(targetIdx, 0, item);
        if (currentTrackIndex === srcIdx) currentTrackIndex = targetIdx;
        else if (currentTrackIndex === targetIdx && srcIdx > targetIdx)
          currentTrackIndex++;
        else if (currentTrackIndex === targetIdx && srcIdx < targetIdx)
          currentTrackIndex--;
        if (currentPlaylistId !== "main") {
          playlists[currentPlaylistId].trackIds = list.map((t) => t.id);
          await savePlaylistsToDB(playlists[currentPlaylistId]);
        }
        selectedIndices.clear();
        selectedIndices.add(targetIdx);
        renderPlaylistUI();
      };
      window.handleDeleteTracks = async () => {
        if (selectedIndices.size === 0) return;
        customConfirm(
          `Remove ${selectedIndices.size} selected track(s)?`,
          async () => {
            const indices = Array.from(selectedIndices).sort((a, b) => b - a);
            if (currentPlaylistId === "main") {
              const list = getCurrentDisplayList();
              for (let i of indices) {
                await deleteTrackFromLib(list[i].id);
                LIBRARY.splice(i, 1);
              }
            } else {
              const pl = playlists[currentPlaylistId];
              for (let i of indices) pl.trackIds.splice(i, 1);
              await savePlaylistsToDB(pl);
            }
            selectedIndices.clear();
            renderPlaylistUI();
          }
        );
      };
      window.handleDeletePlaylist = () => {
        if (currentPlaylistId === "main") return;
        customConfirm(
          `Delete playlist "${playlists[currentPlaylistId].name}"?`,
          () => {
            delete playlists[currentPlaylistId];
            const db = dbReq.result;
            const tx = db.transaction("playlists", "readwrite");
            tx.objectStore("playlists").delete(currentPlaylistId);
            switchPlaylist("main");
            renderPlaylistSelect();
          }
        );
      };

      const fileInput = $("#upload-file");
      $("#btn-pl-add").onclick = () => fileInput.click();
      fileInput.onchange = (e) => handleFiles(e.target.files);
      document.body.ondragover = (e) => e.preventDefault();
      document.body.ondrop = (e) => {
        e.preventDefault();
        handleFiles(e.dataTransfer.files);
      };
      async function handleFiles(files) {
        if (!isEngineHot) await initAudioEngine();
        checkAndResumeAudioContext();
        if (!isEngineHot) await audioContext.resume();
        for (const f of files) {
          const id = "t_" + Date.now() + Math.random();
          const obj = { id, name: f.name, blob: f };
          LIBRARY.push(obj);
          await saveTrackToLib(obj);
          if (currentPlaylistId !== "main") {
            playlists[currentPlaylistId].trackIds.push(id);
            await savePlaylistsToDB(playlists[currentPlaylistId]);
          }
        }
        renderPlaylistUI();
      }
      window.openNewPlaylistModal = () => {
        $("#new-playlist-name").value = "";
        $("#modal-new-playlist").classList.remove("hidden");
        $("#new-playlist-name").focus();
      };
      window.closeNewPlaylistModal = () =>
        $("#modal-new-playlist").classList.add("hidden");
      window.confirmNewPlaylist = () => {
        const n = $("#new-playlist-name").value;
        if (n && n.trim().length > 0) {
          createNewPlaylist(n.trim());
          closeNewPlaylistModal();
        }
      };
      window.createNewPlaylist = (name) => {
        const id = "pl_" + Date.now();
        playlists[id] = { id, name: name, trackIds: [] };
        savePlaylistsToDB(playlists[id]);
        renderPlaylistSelect();
        switchPlaylist(id);
      };
      window.switchPlaylist = (id) => {
        currentPlaylistId = id;
        $("#playlist-select").value = id;
        selectedIndices.clear();
        renderPlaylistUI();
        saveSettings();
      };
      window.renderPlaylistSelect = () => {
        const s = $("#playlist-select");
        s.innerHTML = '<option value="main">Main Library</option>';
        Object.keys(playlists)
          .filter((k) => k !== "main")
          .forEach((k) => {
            const o = document.createElement("option");
            o.value = k;
            o.textContent = playlists[k].name;
            s.appendChild(o);
          });
        s.value = currentPlaylistId;
      };
      $("#playlist-select").onchange = (e) => switchPlaylist(e.target.value);

      // FIXED "SELECT TRACKS FIRST" MODAL CLOSING LOGIC
      window.openAddToModal = () => {
        if (!selectedIndices.size) return customAlert("Select tracks first");
        const d = $("#modal-list");
        d.innerHTML = "";
        Object.keys(playlists)
          .filter((k) => k !== "main")
          .forEach((k) => {
            const b = document.createElement("button");
            b.className =
              "w-full text-left px-2 py-1 text-[10px] text-gray-300 hover:bg-win-green hover:text-black font-pixel border border-gray-600 mb-1";
            b.textContent = playlists[k].name;
            b.onclick = () => {
              const list = getCurrentDisplayList();
              const ids = Array.from(selectedIndices).map((i) => list[i].id);
              playlists[k].trackIds.push(...ids);
              savePlaylistsToDB(playlists[k]);
              closeAddToModal();
              selectedIndices.clear();
              renderPlaylistUI();
            };
            d.appendChild(b);
          });
        $("#modal-add-to").classList.remove("hidden");
      };
      window.closeAddToModal = () => $("#modal-add-to").classList.add("hidden");

      let isShuffle = false,
        repeatMode = 0;
      $("#tog-shuffle").onclick = function () {
        isShuffle = !isShuffle;
        this.classList.toggle("active", isShuffle);
        saveSettings();
      };
      const updateRepeatBtn = () => {
        const btn = $("#tog-repeat");
        btn.classList.remove("active", "active-gold");
        if (repeatMode === 0) btn.textContent = "REPEAT";
        else if (repeatMode === 1) {
          btn.classList.add("active");
          btn.textContent = "REP ALL";
        } else if (repeatMode === 2) {
          btn.classList.add("active-gold");
          btn.textContent = "REP 1";
        }
      };
      $("#tog-repeat").onclick = function () {
        repeatMode = (repeatMode + 1) % 3;
        updateRepeatBtn();
        saveSettings();
      };

      // DUAL PATH MONO/STEREO SWITCH
      const updateMonoStereoState = () => {
        if (isMono) {
          stereoPath.gain.value = 0;
          monoPath.gain.value = 1;

          $("#btn-mono-stereo").textContent = "MONO";
          $("#btn-mono-stereo").classList.remove("theme-text-main");
          $("#btn-mono-stereo").classList.add("theme-text-sec");
        } else {
          stereoPath.gain.value = 1;
          monoPath.gain.value = 0;

          $("#btn-mono-stereo").textContent = "STEREO";
          $("#btn-mono-stereo").classList.add("theme-text-main");
          $("#btn-mono-stereo").classList.remove("theme-text-sec");
        }
      };

      $("#btn-mono-stereo").onclick = async () => {
        if (audioContext.state === "suspended") await audioContext.resume();
        isMono = !isMono;
        updateMonoStereoState();
        saveSettings();
      };

      window.toggleSection = (id) => $(`#${id}`).classList.toggle("hidden");
      let deferredPrompt;
      window.addEventListener("beforeinstallprompt", (e) => {
        e.preventDefault();
        deferredPrompt = e;
        $("#btn-install-pwa").classList.remove("hidden");
      });
      $("#btn-install-pwa").onclick = async () => {
        $("#btn-install-pwa").classList.add("hidden");
        if (deferredPrompt) {
          deferredPrompt.prompt();
          deferredPrompt = null;
        }
      };
      setInterval(() => {
        if (stretch && controlValues.active && !holding && !isChangingTrack) {
          const t = stretch.inputTime || 0;
          if (t >= audioDuration - 0.2) handleNextTrack(true);
        }
      }, 1000);
      const pb = $("#playback");
      let holding = false;
      pb.onmousedown = pb.ontouchstart = () => (holding = true);
      pb.onmouseup = pb.ontouchend = () => {
        holding = false;
        if (stretch) {
          stretch.schedule({
            input: parseFloat(pb.value),
            rate: controlValues.rate,
            semitones: controlValues.semitones,
          });
          updatePositionState();
        }
      };
      pb.oninput = () => {
        if (!stretch) return;
        stretch.schedule({ input: parseFloat(pb.value), rate: 0 });
      };
      $("#main-vol").oninput = (e) => {
        masterGainNode.gain.value = parseFloat(e.target.value);
        $("#txt-vol").textContent = Math.round(e.target.value * 100) + "%";
        saveSettings();
      };
      $("#main-bal").oninput = (e) => {
        pannerNode.pan.value = parseFloat(e.target.value);
        saveSettings();
      };
      $('[data-key="rate"]').oninput = (e) => {
        controlValues.rate = parseFloat(e.target.value);
        $("#val-rate").textContent = controlValues.rate.toFixed(2);
        controlsChanged();
        saveSettings();
      };
      $('[data-key="semitones"]').oninput = (e) => {
        controlValues.semitones = parseFloat(e.target.value);
        $("#val-pitch").textContent = controlValues.semitones;
        controlsChanged();
        saveSettings();
      };
    </script>
  </body>
</html>
